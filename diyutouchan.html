<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ROI å‡€å®æ”¶æ ¸ç®— (V11.0) - å®½å±ç‰ˆ</title>
    <!-- å¼•å…¥ SheetJS ç”¨äºè§£æ Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <!-- å¼•å…¥ ECharts ç”¨äºå›¾è¡¨å±•ç¤º -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        /* --- åŸºç¡€é‡ç½® --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif; background: #f5f7fa; margin: 0; padding: 12px; color: #333; }
        
        /* æ ¸å¿ƒä¿®æ”¹ï¼šå°† max-width ä» 900px æ‰©å¤§åˆ° 1200px */
        .container { max-width: 1200px; margin: 0 auto; transition: all 0.3s ease; }
        .card { background: #fff; border-radius: 12px; padding: 16px; margin-bottom: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.04); transition: all 0.3s ease; }
        
        /* --- å¤´éƒ¨ --- */
        .header { text-align: center; padding: 20px 10px; }
        .header h2 { margin: 0 0 6px 0; color: #1890ff; font-size: 20px; font-weight: 800; letter-spacing: -0.5px; }
        .header p { margin: 0; color: #666; font-size: 12px; opacity: 0.8; }
        .tag-version { background: #e6f7ff; color: #1890ff; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; vertical-align: top; margin-left: 4px; }

        /* --- ä¸Šä¼ åŒºåŸŸ --- */
        .upload-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px; }
        .upload-box { 
            border: 2px dashed #e0e0e0; border-radius: 10px; padding: 15px 5px; text-align: center; 
            background: #fafafa; position: relative; transition: all 0.2s; cursor: pointer; min-height: 120px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .upload-box:active { transform: scale(0.98); background: #f0f0f0; }
        .upload-box.done { border-color: #52c41a; background: #f6ffed; }
        .upload-box.loading { border-color: #1890ff; background: #e6f7ff; cursor: wait; }
        
        /* æ–°å¢ï¼šæ–‡ä»¶å¤¹ä¸Šä¼ åŒºåŸŸæ ·å¼ */
        .upload-folder {
            grid-column: 1 / -1;
            border: 2px dashed #1890ff; border-radius: 10px; padding: 20px 5px; text-align: center;
            background: #e6f7ff; position: relative; transition: all 0.2s; cursor: pointer; min-height: 100px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .upload-folder:hover { background: #bae0ff; }
        .upload-folder:active { transform: scale(0.98); }

        .u-icon { font-size: 28px; margin-bottom: 6px; transition: font-size 0.3s ease; }
        .u-title { font-weight: bold; font-size: 14px; color: #333; margin-bottom: 4px; transition: font-size 0.3s ease; }
        .u-desc { font-size: 11px; color: #999; line-height: 1.4; transition: font-size 0.3s ease; }
        .u-tag { font-size: 10px; background: #eee; padding: 1px 5px; border-radius: 4px; color: #666; margin-left: 4px; vertical-align: middle; }
        .u-highlight { color: #1890ff; font-weight: bold; }
        .file-input { position: absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor: pointer; }

        /* --- æŒ‰é’® --- */
        .action-area { text-align: center; margin-top: 20px; display: flex; flex-direction: column; align-items: center; gap: 12px; }
        .btn-analyze {
            background: #e0e0e0; color: #999; border: none; padding: 12px 40px; 
            border-radius: 50px; font-size: 15px; font-weight: bold; cursor: not-allowed;
            box-shadow: none; transition: 0.3s; width: 100%; max-width: 300px;
        }
        .btn-analyze.active {
            background: linear-gradient(135deg, #1890ff, #096dd9); color: white;
            cursor: pointer; box-shadow: 0 8px 24px rgba(24, 144, 255, 0.3);
        }
        .btn-analyze.active:active { transform: scale(0.98); }

        .btn-reset {
            background: transparent; border: 1px solid #d9d9d9; color: #666;
            padding: 8px 24px; border-radius: 50px; font-size: 13px;
            cursor: pointer; transition: 0.3s; display: none; 
        }
        .btn-reset:hover { border-color: #ff4d4f; color: #ff4d4f; background: #fff1f0; }

        /* --- KPI æŒ‡æ ‡å¡ --- */
        .kpi-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; text-align: center; margin-bottom: 8px; }
        .kpi-item { background: #f8f9fa; padding: 10px 5px; border-radius: 8px; transition: padding 0.3s ease; }
        .kpi-val { font-size: 16px; font-weight: 800; color: #333; display: block; margin-bottom: 4px; font-family: 'DIN Alternate', sans-serif; transition: font-size 0.3s ease; }
        .kpi-lbl { font-size: 11px; color: #888; white-space: nowrap; transition: font-size 0.3s ease; }
        .text-red { color: #ff4d4f; }
        .text-blue { color: #1890ff; }
        .text-green { color: #52c41a; }
        .text-orange { color: #fa8c16; }

        /* --- åˆ—è¡¨éƒ¨åˆ† --- */
        .list-header { display: flex; justify-content: space-between; padding-bottom: 10px; border-bottom: 2px solid #f0f0f0; color: #999; font-size: 12px; font-weight: bold; }
        
        .row { border-bottom: 1px solid #f5f5f5; padding: 14px 0; cursor: pointer; transition: background 0.1s; }
        .row:hover { background: #fafafa; }
        
        .r-main { display: flex; align-items: flex-start; justify-content: space-between; }
        
        .r-left { display: flex; align-items: center; gap: 8px; flex: 1; min-width: 0; padding-top: 4px; }
        .r-idx { width: 20px; height: 20px; background: #eee; color: #999; text-align: center; line-height: 20px; border-radius: 6px; font-size: 11px; font-weight: 700; flex-shrink: 0; }
        .r-idx.top { background: #fff1f0; color: #ff4d4f; }
        .r-name { font-size: 15px; font-weight: 700; color: #333; white-space: nowrap; transition: font-size 0.3s ease; }
        .r-buyer-tag { font-size: 11px; color: #888; background: #f5f5f5; padding: 2px 6px; border-radius: 10px; display: flex; align-items: center; gap: 4px; white-space: nowrap; }
        
        .r-right { text-align: right; flex-shrink: 0; margin-left: 10px; }
        .r-val-main { font-family: 'DIN Alternate', sans-serif; font-weight: 700; font-size: 18px; line-height: 1.2; transition: font-size 0.3s ease; }
        .r-val-sub { font-size: 11px; color: #666; margin-top: 2px; display: block; transition: font-size 0.3s ease; }
        .r-val-ter { font-size: 10px; color: #999; margin-top: 1px; display: block; }
        
        .detail-box { display: none; background: #fcfcfc; padding: 8px; border: 1px solid #eee; margin-top: 10px; border-radius: 8px; overflow-x: auto; }
        .row.open .detail-box { display: block; animation: slideDown 0.2s; }
        
        .grid-row { 
            display: grid; 
            gap: 2px; 
            align-items: center; 
            padding: 8px 0; 
            border-bottom: 1px dashed #f0f0f0; 
            font-size: 11px; 
            color: #666; 
            transition: font-size 0.3s ease;
        }
        
        .grid-row.head { 
            font-weight: bold; 
            color: #999; 
            font-size: 10px; 
            border-bottom: 2px solid #eee; 
            padding-bottom: 6px; 
            margin-bottom: 4px; 
            background: #f9f9f9;
            border-radius: 4px 4px 0 0;
            transition: font-size 0.3s ease;
        }
        
        .cell { overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .cell-left { text-align: left; }
        .cell-center { text-align: center; }
        .cell-right { text-align: right; }
        
        .c-name { font-weight: 500; color: #333; display: flex; align-items: center; gap: 4px; }
        .c-count { font-family: 'DIN Alternate', monospace; background: #f0f0f0; border-radius: 4px; color: #666; font-size: 10px; padding: 1px 0; transition: font-size 0.3s ease; text-align: center; }
        .c-count-red { font-family: 'DIN Alternate', monospace; background: #fff1f0; border-radius: 4px; color: #ff4d4f; font-size: 10px; padding: 1px 0; transition: font-size 0.3s ease; text-align: center; }
        .c-num { font-family: 'DIN Alternate', monospace; }
        .c-bold { font-weight: bold; color: #333; }
        
        .bar-wrap { height: 6px; background: #f0f0f0; border-radius: 3px; overflow: hidden; display: flex; margin-top: 8px; }
        
        .col-red { color: #ff4d4f; }
        .col-green { color: #52c41a; }
        .col-gray { color: #ccc; }
        .col-orange { color: #fa8c16; }

        .spinner { width: 20px; height: 20px; border: 3px solid rgba(24,144,255,0.2); border-top-color: #1890ff; border-radius: 50%; animation: spin 0.8s linear infinite; }
        
        /* æ–°å¢ï¼šç­›é€‰åŒºåŸŸæ ·å¼ & å¯¼å‡ºæŒ‰é’® */
        .filter-title { font-size: 14px; font-weight: bold; margin-bottom: 12px; color: #333; display: flex; align-items: center; gap: 6px; justify-content: space-between; }
        .filter-inputs { display: flex; flex-wrap: wrap; gap: 16px; align-items: flex-end; }
        .f-group { display: flex; flex-direction: column; gap: 6px; }
        .f-group label { font-size: 12px; color: #666; font-weight: 500; }
        .f-range { display: flex; align-items: center; gap: 4px; background: #f5f5f5; border-radius: 6px; padding: 4px 8px; border: 1px solid #eee; }
        .f-range input { width: 60px; border: none; background: transparent; text-align: center; font-size: 13px; outline: none; }
        .f-range input::-webkit-outer-spin-button, .f-range input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .f-range span { color: #999; font-size: 12px; }
        .btn-filter { background: #1890ff; color: #fff; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: bold; transition: 0.2s; height: 32px; }
        .btn-filter:hover { background: #096dd9; }
        .btn-clear { background: #fff; color: #666; border: 1px solid #d9d9d9; padding: 7px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; transition: 0.2s; height: 32px; }
        .btn-clear:hover { color: #ff4d4f; border-color: #ff4d4f; background: #fff1f0; }
        .btn-export { background: #52c41a; }
        .btn-export:hover { background: #389e0d; }

        /* æ–°å¢ï¼šå¤åˆ¶æŒ‰é’®æ ·å¼ */
        .btn-copy { cursor: pointer; opacity: 0.4; font-size: 12px; transition: 0.2s; user-select: none; }
        .btn-copy:hover { opacity: 1; transform: scale(1.1); }

        /* æ–°å¢ï¼šToast æç¤ºæ ·å¼ */
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.75); color: #fff; padding: 10px 20px; border-radius: 6px; font-size: 14px; z-index: 9999; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.15); animation: slideDown 0.3s; }

        /* é»˜è®¤å›¾è¡¨é«˜åº¦ (ç§»åŠ¨ç«¯) */
        #chart-box { height: 300px; width: 100%; transition: height 0.3s ease; }

        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* =========================================
           æ–°å¢åŠ ï¼šé’ˆå¯¹ç”µè„‘ç«¯å¤§ç”»å¹…æµè§ˆå™¨çš„å“åº”å¼ä¼˜åŒ– 
           ========================================= */
        @media (min-width: 768px) {
            body { padding: 24px; }
            .card { padding: 32px; margin-bottom: 24px; }
            
            /* æ ‡é¢˜åŒºåŸŸ */
            .header { padding: 30px 20px; }
            .header h2 { font-size: 28px; margin-bottom: 12px; }
            .header p { font-size: 15px; }
            .tag-version { font-size: 12px; padding: 4px 8px; }

            /* ä¸Šä¼ åŒºåŸŸå˜å¤§ */
            .upload-grid { gap: 24px; margin-top: 30px; }
            .upload-box { min-height: 180px; padding: 25px; }
            .upload-folder { min-height: 140px; padding: 30px; }
            .u-icon { font-size: 42px; margin-bottom: 12px; }
            .u-title { font-size: 18px; margin-bottom: 8px; }
            .u-desc { font-size: 14px; }

            /* æŒ‰é’®åŒºåŸŸå¹¶æ’å±…ä¸­ */
            .action-area { flex-direction: row; justify-content: center; gap: 20px; margin-top: 30px; }
            .btn-analyze { font-size: 16px; padding: 14px 50px; max-width: 350px; }
            .btn-reset { font-size: 14px; padding: 12px 30px; }

            /* KPI æŒ‡æ ‡å¡æ”¾å¤§ */
            .kpi-row { gap: 20px; margin-bottom: 20px; }
            .kpi-item { padding: 25px 15px; border-radius: 12px; }
            .kpi-val { font-size: 28px; margin-bottom: 8px; }
            .kpi-lbl { font-size: 14px; }

            /* å›¾è¡¨é«˜åº¦æ‰©å¤§ */
            #chart-box { height: 450px !important; }

            /* åˆ—è¡¨å†…å®¹é€‚é…å¤§å±å­—å· */
            .list-header { font-size: 15px; padding-bottom: 15px; }
            .row { padding: 20px 0; }
            .r-name { font-size: 18px; }
            .r-idx { width: 26px; height: 26px; line-height: 26px; font-size: 13px; border-radius: 8px; }
            .r-buyer-tag { font-size: 13px; padding: 4px 10px; }
            .r-val-main { font-size: 24px; }
            .r-val-sub { font-size: 13px; margin-top: 6px; }
            .r-val-ter { font-size: 12px; margin-top: 4px; }
            
            /* åŸå¸‚æ˜ç»†ç½‘æ ¼é—´è·å’Œå­—å· */
            .detail-box { padding: 16px; margin-top: 15px; border-radius: 10px; }
            .grid-row { font-size: 14px; padding: 12px 0; gap: 8px; }
            .grid-row.head { font-size: 13px; padding-bottom: 10px; margin-bottom: 8px; }
            .c-count, .c-count-red { font-size: 13px; padding: 3px 6px; }
            
            /* ç­›é€‰åŒºåŸŸå¤§å±é€‚é… */
            .f-range input { width: 80px; font-size: 14px; }
            .btn-filter, .btn-clear { padding: 8px 24px; font-size: 14px; height: 36px; }
        }
    </style>
</head>
<body>

<!-- å…¨å±€è½»æç¤º -->
<div id="toast"></div>

<div class="container">
    <div class="card header">
        <h2>ğŸ’° ROI å‡€å®æ”¶æ ¸ç®— <span class="tag-version">V11.0</span></h2>
        <p>å®æ”¶ = å–å®¶å®æ”¶ - é€€æ¬¾é‡‘é¢ | å‰”é™¤è™šé«˜äº§å‡º</p>
        
        <div class="upload-grid">
            <div class="upload-folder" id="box-folder">
                <div id="icon-folder" class="u-icon">ğŸ“</div>
                <div class="u-title" id="txt-folder">ä¸€é”®æ‰¹é‡å¤šé€‰æ–‡ä»¶ä¸Šä¼ </div>
                <div class="u-desc">ç‚¹å‡»åå¯æ¡†é€‰å¤šä¸ªæ–‡ä»¶ï¼Œè‡ªåŠ¨è¯†åˆ« <span class="u-highlight">è®¢å•</span> å’Œ <span class="u-highlight">åœ°åŸŸ / æ¨å¹¿</span> æŠ¥è¡¨</div>
                <input type="file" id="fileFolder" class="file-input" multiple accept=".xlsx, .xls, .csv">
            </div>

            <div class="upload-box" id="box-order">
                <div id="icon-order" class="u-icon">ğŸ“¦</div>
                <div class="u-title" id="txt-order">è®¢å•æŠ¥è¡¨</div>
                <div class="u-desc" id="desc-order">æå– <span class="u-highlight">å®æ”¶ & é€€æ¬¾</span></div>
                <input type="file" id="fileOrder" class="file-input" accept=".xlsx, .xls, .csv">
            </div>
            <div class="upload-box" id="box-ad">
                <div id="icon-ad" class="u-icon">ğŸ“¢</div>
                <div class="u-title" id="txt-ad">æ¨å¹¿æŠ¥è¡¨<span class="u-tag">å¯é€‰</span></div>
                <div class="u-desc" id="desc-ad">å¦‚æœ‰æ¨å¹¿æ•°æ®<br>è‡ªåŠ¨è®¡ç®— ROI</div>
                <input type="file" id="fileAd" class="file-input" accept=".xlsx, .xls, .csv">
            </div>
        </div>

        <div class="action-area">
            <button id="btn-analyze" class="btn-analyze" disabled>è¯·è‡³å°‘ä¸Šä¼ è®¢å•è¡¨</button>
            <button id="btn-reset" class="btn-reset">ğŸ—‘ï¸ æ¸…ç©ºé‡ç½®</button>
        </div>
        <p id="status-msg" style="text-align:center;color:#999;font-size:13px;margin-top:10px;height:20px;"></p>
    </div>

    <div id="result-area" style="display: none;">
        <!-- KPI çœ‹æ¿ -->
        <div class="card">
            <div class="kpi-row">
                <div class="kpi-item">
                    <span class="kpi-val text-blue" id="k-amt">0</span>
                    <span class="kpi-lbl">å‡€å®æ”¶æ€»é¢</span>
                </div>
                <div class="kpi-item">
                    <span class="kpi-val text-red" id="k-cost">0</span>
                    <span class="kpi-lbl" id="lbl-cost">é€€æ¬¾æ€»é¢</span>
                </div>
                <div class="kpi-item">
                    <span class="kpi-val text-green" id="k-roi">0</span>
                    <span class="kpi-lbl" id="lbl-roi">é€€å®¢ç‡</span>
                </div>
            </div>
            <div class="kpi-row">
                <div class="kpi-item">
                    <span class="kpi-val" id="k-orders">0</span>
                    <span class="kpi-lbl">ä¹°å®¶æ•°(å»é‡)</span>
                </div>
                <div class="kpi-item" style="background:transparent;"></div>
                <div class="kpi-item" style="background:transparent;"></div>
            </div>
        </div>

        <div class="card">
            <div id="chart-box"></div>
        </div>

        <!-- æ•°æ®ç­›é€‰æ¨¡å— -->
        <div class="card" id="filter-section" style="display: none;">
            <div class="filter-title">
                <span><span>ğŸ”</span> ç²¾ç»†åŒ–æ•°æ®ç­›é€‰</span>
            </div>
            <div class="filter-inputs">
                <div class="f-group roi-filter">
                    <label>çœæŠ•äº§ (ROI)</label>
                    <div class="f-range">
                        <input type="number" id="f-p-roi-min" placeholder="æœ€å°"> <span>-</span> <input type="number" id="f-p-roi-max" placeholder="æœ€å¤§">
                    </div>
                </div>
                <div class="f-group roi-filter">
                    <label>å¸‚æŠ•äº§ (ROI)</label>
                    <div class="f-range">
                        <input type="number" id="f-c-roi-min" placeholder="æœ€å°"> <span>-</span> <input type="number" id="f-c-roi-max" placeholder="æœ€å¤§">
                    </div>
                </div>
                <!-- æ–°å¢ï¼šå¸‚èŠ±è´¹åŒºé—´ç­›é€‰ -->
                <div class="f-group roi-filter">
                    <label>å¸‚èŠ±è´¹ (Â¥)</label>
                    <div class="f-range">
                        <input type="number" id="f-cost-min" placeholder="æœ€å°"> <span>-</span> <input type="number" id="f-cost-max" placeholder="æœ€å¤§">
                    </div>
                </div>
                <div class="f-group">
                    <label>å¸‚é€€å®¢ç‡ (%)</label>
                    <div class="f-range">
                        <input type="number" id="f-rate-min" placeholder="æœ€å°"> <span>-</span> <input type="number" id="f-rate-max" placeholder="æœ€å¤§">
                    </div>
                </div>
                <div class="f-actions" style="display:flex; gap:10px; flex-wrap: wrap;">
                    <button id="btn-apply-filter" class="btn-filter">æ‰§è¡Œç­›é€‰</button>
                    <button id="btn-clear-filter" class="btn-clear">æ¸…ç©ºæ¡ä»¶</button>
                    <!-- æ–°å¢ï¼šå¯¼å‡ºæŠ¥è¡¨æŒ‰é’® -->
                    <button id="btn-export-report" class="btn-filter btn-export">â¬‡ï¸ å¯¼å‡ºæŠ¥è¡¨</button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="list-header">
                <span id="list-title">åŒºåŸŸæ’è¡Œ</span>
                <span id="list-cols">æ•°æ®æ¦‚è§ˆ</span>
            </div>
            <div id="list-box"></div>
        </div>
    </div>
</div>

<script>
    const $ = id => document.getElementById(id);
    const fmtMoney = n => 'Â¥' + Math.round(n).toLocaleString();
    const cleanStr = str => String(str || '').trim().replace(/[\ufeff\s"]/g, '');
    
    // --- æ™ºèƒ½ç»Ÿä¸€åœ°åŸŸåˆ«å ---
    const normalizeAddr = name => {
        if (!name) return '';
        let str = String(name).trim();
        if (str === '-' || str === 'æœªçŸ¥') return '';
        
        // --- æ ¸å¿ƒä¿®å¤ï¼šå¤„ç†éƒ¨åˆ†å¹³å°ç®€å†™ä¸æ ‡å‡†åç§°ä¸ä¸€è‡´çš„æƒ…å†µ ---
        if (str.includes('å†…è’™')) return 'å†…è’™å¤';
        if (str.includes('æ–°ç–†')) return 'æ–°ç–†';
        if (str.includes('å¹¿è¥¿')) return 'å¹¿è¥¿';
        if (str.includes('å®å¤')) return 'å®å¤';
        if (str.includes('è¥¿è—')) return 'è¥¿è—';

        // å¸¸è§„åç¼€è¿‡æ»¤
        ['çœ', 'ç»´å¾å°”è‡ªæ²»åŒº', 'å£®æ—è‡ªæ²»åŒº', 'å›æ—è‡ªæ²»åŒº', 'è‡ªæ²»åŒº', 'ç‰¹åˆ«è¡Œæ”¿åŒº'].forEach(s => {
            if (str.endsWith(s) && str.length > 2) str = str.replace(s, '');
        });
        if(str.endsWith('å¸‚') && str.length <= 4) str = str.replace('å¸‚', '');
        return str;
    };

    const getCleanCityName = (city, province) => {
        if (!city || !province) return city;
        
        let res = city;
        if (city.startsWith(province) && city.length > province.length) {
            res = city.replace(province, '');
        } else {
            const provWithSuffix = province + 'çœ';
            if (city.startsWith(provWithSuffix)) {
                res = city.replace(provWithSuffix, '');
            }
        }
        
        // æ ¸å¿ƒä¿®å¤ï¼šé˜²æ­¢å¦‚â€œå‰æ—çœå‰æ—å¸‚â€è¢«å‰”é™¤çœä»½ååä»…å‰©â€œå¸‚â€å­—
        // å¦‚æœå‰”é™¤ååªå‰©ä¸€ä¸ªå­—ï¼ˆå¦‚å¸‚ã€å·ã€åŒºã€å¿ï¼‰ï¼Œè¯´æ˜è¿™æ˜¯çœå¸‚åŒåï¼Œéœ€è¦è¿˜åŸä¸ºåŸå§‹åç§°
        if (/^[å¸‚å·åŒºå¿ç›Ÿ]$/.test(res)) {
            return city;
        }
        
        return res;
    };

    // æ˜¾ç¤ºè½»æç¤º (Toast)
    function showToast(msg) {
        const toast = $('toast');
        toast.innerText = msg;
        toast.style.display = 'block';
        setTimeout(() => { toast.style.display = 'none'; }, 2000);
    }

    // å¤åˆ¶æ–‡æœ¬åˆ°å‰ªè´´æ¿
    function copyText(text, event) {
        event.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘è¡Œçš„æŠ˜å /å±•å¼€
        const temp = document.createElement('textarea');
        temp.value = text;
        document.body.appendChild(temp);
        temp.select();
        document.execCommand('copy');
        document.body.removeChild(temp);
        showToast(`å·²å¤åˆ¶: ${text}`);
    }

    let orderData = null;
    let adData = null;
    let myChart = null; 

    // å…¨å±€ä¿å­˜åˆå¹¶åçš„åˆ—è¡¨æ•°æ®ç”¨äºç­›é€‰
    let globalList = [];
    let globalShowRoi = false;
    // æ–°å¢ï¼šä¿å­˜å½“å‰æ­£åœ¨æ˜¾ç¤ºçš„ç­›é€‰åæ•°æ®ï¼Œç”¨äºå¯¼å‡º
    let currentDisplayList = [];

    $('fileOrder').addEventListener('change', e => startProcess(e.target, 'order'));
    $('fileAd').addEventListener('change', e => startProcess(e.target, 'ad'));
    $('fileFolder').addEventListener('change', handleFolderUpload);
    $('btn-analyze').addEventListener('click', mergeAndAnalyze);
    $('btn-reset').addEventListener('click', resetAll);

    $('btn-apply-filter').addEventListener('click', applyFilters);
    $('btn-clear-filter').addEventListener('click', () => {
        ['f-p-roi-min', 'f-p-roi-max', 'f-c-roi-min', 'f-c-roi-max', 'f-cost-min', 'f-cost-max', 'f-rate-min', 'f-rate-max'].forEach(id => $(id).value = '');
        applyFilters();
    });
    $('btn-export-report').addEventListener('click', exportReport);

    function handleFolderUpload(e) {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;

        files.sort((a, b) => b.lastModified - a.lastModified);

        let orderFile = null;
        let adFile = null;

        for (let file of files) {
            if (file.name.startsWith('~') || file.name.startsWith('.')) continue;
            
            if (!orderFile && file.name.includes('è®¢å•')) orderFile = file;
            if (!adFile && (file.name.includes('åœ°åŸŸ') || file.name.includes('æ¨å¹¿'))) adFile = file;
            
            if (orderFile && adFile) break; 
        }

        if (!orderFile && !adFile) {
            showToast("âŒ æœªæ‰¾åˆ°åç§°åŒ…å«ã€Œè®¢å•ã€æˆ–ã€Œåœ°åŸŸ/æ¨å¹¿ã€çš„æ–‡ä»¶");
            $('status-msg').innerText = "âŒ æœªæ‰¾åˆ°æŠ¥è¡¨æ–‡ä»¶";
            $('status-msg').style.color = '#ff4d4f';
            return;
        }

        if (orderFile) processSingleFile(orderFile, 'order');
        if (adFile) processSingleFile(adFile, 'ad');
    }

    function startProcess(input, type) {
        const file = input.files[0];
        if(!file) return;
        processSingleFile(file, type);
    }

    function processSingleFile(file, type) {
        const box = $(type === 'order' ? 'box-order' : 'box-ad');
        const icon = $(type === 'order' ? 'icon-order' : 'icon-ad');
        box.className = 'upload-box loading';
        icon.innerHTML = '<div class="spinner"></div>';
        $('status-msg').innerText = `æ­£åœ¨è§£æ: ${file.name}`;
        $('status-msg').style.color = '#999';
        
        setTimeout(() => {
            if (file.name.endsWith('.csv')) parseCSV(file, type);
            else parseExcel(file, type);
        }, 50);
    }

    function parseCSV(file, type) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const buffer = e.target.result;
            let text = '';
            const decoderUTF = new TextDecoder('utf-8');
            const strUTF = decoderUTF.decode(buffer);
            const keywords = type === 'order' ? ['è®¢å•', 'é‡‘é¢', 'å®æ”¶'] : ['èŠ±è´¹', 'çœ', 'åœ°åŸŸ', 'æ¶ˆè€—'];
            const isUTFValid = keywords.some(k => strUTF.includes(k));
            if (isUTFValid) text = strUTF;
            else {
                const decoderGBK = new TextDecoder('gbk');
                text = decoderGBK.decode(buffer);
            }
            const rows = csvToJson(text);
            processData(rows, type);
        };
        reader.readAsArrayBuffer(file);
    }

    function csvToJson(text) {
        const lines = text.split(/\r\n|\n/);
        const result = [];
        if (lines.length < 2) return [];
        const headers = lines[0].split(',').map(h => cleanStr(h));
        for (let i = 1; i < lines.length; i++) {
            if (!lines[i].trim()) continue;
            const row = lines[i].split(','); 
            if (row.length < headers.length) continue;
            const obj = {};
            headers.forEach((h, idx) => { obj[h] = row[idx] ? cleanStr(row[idx]) : ''; });
            result.push(obj);
        }
        return result;
    }

    function parseExcel(file, type) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(sheet, { defval: "" });
            processData(json, type);
        };
        reader.readAsArrayBuffer(file);
    }

    function processData(data, type) {
        try {
            const keys = Object.keys(data[0]);
            
            if (type === 'order') {
                const cProv = keys.find(k => k.includes('çœ'));
                const cCity = keys.find(k => k.includes('å¸‚') || k.includes('åŸ'));
                
                let cAmt = keys.find(k => cleanStr(k) === 'å–å®¶å®æ”¶');
                if (!cAmt) cAmt = keys.find(k => k.includes('å®æ”¶') || k.includes('é‡‘é¢'));
                
                let cOid = keys.find(k => k.includes('åŸå§‹çº¿ä¸Šè®¢å•å·'));
                if (!cOid) cOid = keys.find(k => k.includes('çº¿ä¸Šè®¢å•å·') || k.includes('è®¢å•å·'));

                let cRef = keys.find(k => k.includes('é€€æ¬¾'));

                if (!cAmt) throw new Error("æœªæ‰¾åˆ°ã€å–å®¶å®æ”¶ã€‘åˆ—");

                let totalNetAmt = 0; 
                let totalRefund = 0;
                let validOrders = new Set();
                let globalRefundOrders = new Set();
                const map = {};

                data.forEach(row => {
                    const received = parseFloat(String(row[cAmt]).replace(/,/g, ''));
                    if (isNaN(received)) return;

                    let refund = 0;
                    if(cRef) {
                        const r = parseFloat(String(row[cRef]).replace(/,/g, ''));
                        if(!isNaN(r)) refund = r;
                    }

                    const netAmt = received - refund;

                    const prov = normalizeAddr(row[cProv]);
                    const city = normalizeAddr(row[cCity]);
                    const oid = row[cOid]; 

                    if (!prov || prov === 'æœªçŸ¥') return;

                    if (!map[prov]) map[prov] = { amt: 0, refund: 0, orders: new Set(), refundOrders: new Set(), cities: {} };
                    
                    let rawCityName = row[cCity] ? String(row[cCity]).trim() : city;
                    if (!map[prov].cities[city]) {
                        map[prov].cities[city] = { amt: 0, refund: 0, orders: new Set(), refundOrders: new Set(), rawName: rawCityName };
                    }

                    map[prov].amt += netAmt; 
                    map[prov].refund += refund;
                    map[prov].cities[city].amt += netAmt; 
                    map[prov].cities[city].refund += refund;
                    
                    totalNetAmt += netAmt;
                    totalRefund += refund;

                    if (oid) {
                        map[prov].orders.add(oid);
                        map[prov].cities[city].orders.add(oid);
                        validOrders.add(oid);
                        
                        // è®°å½•å‘ç”Ÿè¿‡é€€æ¬¾çš„ç‹¬ç‰¹ä¹°å®¶æ•°
                        if (refund > 0) {
                            map[prov].refundOrders.add(oid);
                            map[prov].cities[city].refundOrders.add(oid);
                            globalRefundOrders.add(oid);
                        }
                    }
                });
                
                orderData = { total: totalNetAmt, totalRefund, count: validOrders.size, refundCount: globalRefundOrders.size, map };
                updateStatus('box-order', 'icon-order', 'ğŸ“¦', `å‡€å®æ”¶${fmtMoney(totalNetAmt)} | ${validOrders.size}äºº`);

            } else {
                const cProv = keys.find(k => k.includes('çœ') || k.includes('åœ°åŸŸ'));
                const cCity = keys.find(k => k.includes('å¸‚') || k.includes('åŸ'));
                const cCost = keys.find(k => k.includes('èŠ±è´¹') || k.includes('æ¶ˆè€—'));

                if (!cCost) throw new Error("æœªæ‰¾åˆ°ã€èŠ±è´¹ã€‘åˆ—");

                let total = 0;
                const map = {};

                data.forEach(row => {
                    const cost = parseFloat(String(row[cCost]).replace(/,/g, ''));
                    if (isNaN(cost)) return;

                    const prov = normalizeAddr(row[cProv]);
                    const city = normalizeAddr(row[cCity]);
                    if (!prov || prov === 'æœªçŸ¥') return;

                    if (!map[prov]) map[prov] = { cost: 0, cities: {} };
                    if (!map[prov].cities[city]) map[prov].cities[city] = 0;

                    map[prov].cost += cost;
                    map[prov].cities[city] += cost;
                    total += cost;
                });
                adData = { total, map };
                updateStatus('box-ad', 'icon-ad', 'ğŸ“¢', `èŠ±è´¹${fmtMoney(total)}`);
            }

            $('status-msg').innerText = "";
            checkReady();

        } catch (err) {
            console.error(err);
            const box = $(type === 'order' ? 'box-order' : 'box-ad');
            box.className = 'upload-box'; 
            showToast("è§£æå¤±è´¥: " + err.message);
            $('status-msg').innerText = "âŒ è§£æå¤±è´¥";
            $('status-msg').style.color = '#ff4d4f';
        }
    }

    function updateStatus(boxId, iconId, icon, text) {
        $(boxId).className = 'upload-box done';
        $(iconId).innerHTML = icon;
        $(boxId).querySelector('.u-title').innerHTML = text;
        $(boxId).querySelector('.u-desc').innerText = "âœ… è§£ææˆåŠŸ";
    }

    function checkReady() {
        if (orderData || adData) {
            $('btn-reset').style.display = 'inline-block';
        }

        const btn = $('btn-analyze');
        if (orderData) {
            btn.disabled = false;
            btn.classList.add('active');
            btn.innerText = adData ? "ğŸš€ å¼€å§‹å…¨èƒ½åˆ†æ" : "ğŸš€ å¼€å§‹é”€å”®åˆ†æ";
        }
    }

    function resetAll() {
        orderData = null;
        adData = null;
        if (myChart) {
            myChart.dispose();
            myChart = null;
        }

        $('fileOrder').value = '';
        $('fileAd').value = '';
        $('fileFolder').value = '';

        resetBox('box-order', 'icon-order', 'ğŸ“¦', 'è®¢å•æŠ¥è¡¨', 'æå– <span class="u-highlight">å®æ”¶ & é€€æ¬¾</span>');
        resetBox('box-ad', 'icon-ad', 'ğŸ“¢', 'æ¨å¹¿æŠ¥è¡¨<span class="u-tag">å¯é€‰</span>', 'å¦‚æœ‰æ¨å¹¿æ•°æ®<br>è‡ªåŠ¨è®¡ç®— ROI');

        const btn = $('btn-analyze');
        btn.disabled = true;
        btn.classList.remove('active');
        btn.innerText = "è¯·è‡³å°‘ä¸Šä¼ è®¢å•è¡¨";
        btn.style.background = '#e0e0e0';

        $('btn-reset').style.display = 'none';
        $('result-area').style.display = 'none';
        $('filter-section').style.display = 'none';
        $('status-msg').innerText = '';
        $('list-box').innerHTML = '';

        ['f-p-roi-min', 'f-p-roi-max', 'f-c-roi-min', 'f-c-roi-max', 'f-cost-min', 'f-cost-max', 'f-rate-min', 'f-rate-max'].forEach(id => $(id).value = '');
    }

    function resetBox(boxId, iconId, iconChar, titleHtml, descHtml) {
        const box = $(boxId);
        box.className = 'upload-box';
        $(iconId).innerHTML = iconChar;
        box.querySelector('.u-title').innerHTML = titleHtml;
        box.querySelector('.u-desc').innerHTML = descHtml;
    }

    function mergeAndAnalyze() {
        $('result-area').style.display = 'block';
        $('btn-analyze').innerText = "ğŸ”„ åˆ†æå®Œæˆ";
        $('btn-analyze').style.background = '#87d068';
        $('btn-analyze').disabled = true;

        $('k-amt').innerText = fmtMoney(orderData.total);
        $('k-orders').innerText = orderData.count.toLocaleString();
        
        if (adData) {
            $('lbl-cost').innerText = "æ¨å¹¿èŠ±è´¹";
            $('k-cost').innerText = fmtMoney(adData.total);
            const globalRoi = adData.total > 0 ? (orderData.total / adData.total).toFixed(2) : 'âˆ';
            $('lbl-roi').innerText = "æ•´ä½“ ROI";
            $('k-roi').innerText = globalRoi;
            $('k-roi').className = 'kpi-val ' + getRoiColor(orderData.total / adData.total);
            $('list-title').innerText = "åŒºåŸŸ (æŒ‰èŠ±è´¹é™åº)";
            $('list-cols').innerText = "ROI / å‡€å®æ”¶ / èŠ±è´¹";
        } else {
            $('lbl-cost').innerText = "é€€æ¬¾æ€»é¢";
            $('k-cost').innerText = fmtMoney(orderData.totalRefund);
            const refRate = orderData.count > 0 ? (orderData.refundCount / orderData.count * 100).toFixed(2) : 0;
            
            $('lbl-roi').innerText = "é€€å®¢ç‡";
            $('k-roi').innerText = refRate + '%';
            $('k-roi').className = 'kpi-val ' + (refRate > 20 ? 'text-red' : (refRate > 10 ? 'text-orange' : 'text-green'));
            $('list-title').innerText = "åŒºåŸŸ (æŒ‰å‡€å®æ”¶é™åº)";
            $('list-cols').innerText = "é€€æ¬¾ / å æ¯” / å‡€å®æ”¶";
        }

        const allProvs = new Set([...Object.keys(orderData.map), ...(adData ? Object.keys(adData.map) : [])]);
        const list = [];

        allProvs.forEach(p => {
            const o = orderData.map[p] || { amt: 0, refund: 0, orders: new Set(), refundOrders: new Set(), cities: {} };
            const a = (adData && adData.map[p]) ? adData.map[p] : { cost: 0, cities: {} };
            
            const allCities = new Set([...Object.keys(o.cities), ...Object.keys(a.cities)]);
            const cityList = [];
            
            allCities.forEach(c => {
                const cData = o.cities[c] || { amt: 0, refund: 0, orders: new Set(), refundOrders: new Set(), rawName: c };
                const cAmt = cData.amt; 
                const cRefund = cData.refund;
                const cCost = a.cities[c] || 0;
                const cCount = cData.orders.size;
                const cRefundCount = cData.refundOrders ? cData.refundOrders.size : 0;

                if (cAmt === 0 && cCost === 0 && cRefund === 0) return;
                
                const roi = cCost > 0 ? cAmt / cCost : (cAmt > 0 ? 999 : 0);
                const rate = cCount > 0 ? (cRefundCount / cCount * 100) : 0;
                
                let rawCity = cData.rawName || c;
                let displayName = getCleanCityName(rawCity, p);
                if (displayName === rawCity) displayName = getCleanCityName(c, p);

                cityList.push({ 
                    name: displayName, 
                    amt: cAmt, 
                    refund: cRefund, 
                    rate: rate, 
                    cost: cCost, 
                    count: cCount, 
                    refundCount: cRefundCount, 
                    roi: roi 
                });
            });
            
            if (adData) cityList.sort((x, y) => y.cost - x.cost);
            else cityList.sort((x, y) => y.amt - x.amt);

            const pRoi = a.cost > 0 ? o.amt / a.cost : (o.amt > 0 ? 999 : 0);
            const pRefundCount = o.refundOrders ? o.refundOrders.size : 0;
            const pRate = o.orders.size > 0 ? (pRefundCount / o.orders.size * 100) : 0;
            
            list.push({ 
                name: p, 
                amt: o.amt, 
                refund: o.refund,
                rate: pRate,
                cost: a.cost, 
                count: o.orders.size, 
                refundCount: pRefundCount,
                roi: pRoi, 
                cities: cityList 
            });
        });

        if (adData) list.sort((a, b) => b.cost - a.cost);
        else list.sort((a, b) => b.amt - a.amt);

        globalList = list;
        globalShowRoi = !!adData;
        $('filter-section').style.display = 'block';
        
        document.querySelectorAll('.roi-filter').forEach(el => el.style.display = globalShowRoi ? 'flex' : 'none');

        applyFilters();
        
        setTimeout(() => {
            if(myChart) myChart.resize();
            $('result-area').scrollIntoView({behavior: "smooth"})
        }, 100);
    }

    function applyFilters() {
        const pRoiMin = parseFloat($('f-p-roi-min').value);
        const pRoiMax = parseFloat($('f-p-roi-max').value);
        const cRoiMin = parseFloat($('f-c-roi-min').value);
        const cRoiMax = parseFloat($('f-c-roi-max').value);
        const costMin = parseFloat($('f-cost-min').value);
        const costMax = parseFloat($('f-cost-max').value);
        const rateMin = parseFloat($('f-rate-min').value);
        const rateMax = parseFloat($('f-rate-max').value);

        const filteredList = [];

        globalList.forEach(p => {
            let keepProv = true;
            if (globalShowRoi) {
                if (!isNaN(pRoiMin) && p.roi < pRoiMin) keepProv = false;
                if (!isNaN(pRoiMax) && p.roi > pRoiMax) keepProv = false;
            }

            if (!keepProv) return; 

            const filteredCities = p.cities.filter(c => {
                let keepCity = true;
                if (globalShowRoi) {
                    if (!isNaN(cRoiMin) && c.roi < cRoiMin) keepCity = false;
                    if (!isNaN(cRoiMax) && c.roi > cRoiMax) keepCity = false;
                    if (!isNaN(costMin) && c.cost < costMin) keepCity = false;
                    if (!isNaN(costMax) && c.cost > costMax) keepCity = false;
                }
                
                if (!isNaN(rateMin) && c.rate < rateMin) keepCity = false;
                if (!isNaN(rateMax) && c.rate > rateMax) keepCity = false;
                
                return keepCity;
            });

            if (p.cities.length > 0 && filteredCities.length === 0) return;

            filteredList.push({
                ...p,
                cities: filteredCities
            });
        });

        currentDisplayList = filteredList; // ä¿å­˜ç”¨äºå¯¼å‡ºçš„æ•°æ®
        renderList(filteredList, globalShowRoi);
        renderChart(filteredList, globalShowRoi);
    }

    function renderList(list, showRoi) {
        const box = $('list-box');
        box.innerHTML = '';
        list.forEach((item, idx) => {
            if (item.amt === 0 && item.cost === 0 && item.refund === 0) return;
            
            const rankClass = idx < 3 ? 'r-idx top' : 'r-idx';
            let rightInfo = '';
            let barHtml = '';
            
            let headerCells = '';
            let gridStyle = ''; 

            if (showRoi) {
                gridStyle = 'grid-template-columns: 85px 40px 40px 45px minmax(55px, 1fr) minmax(55px, 1fr) minmax(50px, 1fr) minmax(55px, 1fr) 45px;';
                headerCells = `
                    <span class="cell-left">åŸå¸‚</span>
                    <span class="cell-center">ä¹°å®¶</span>
                    <span class="cell-center">é€€å®¢</span>
                    <span class="cell-right">é€€ç‡</span>
                    <span class="cell-right">æ€»æ”¯ä»˜</span>
                    <span class="cell-right">å‡€å®æ”¶</span>
                    <span class="cell-right">é€€æ¬¾</span>
                    <span class="cell-right">èŠ±è´¹</span>
                    <span class="cell-right">ROI</span>
                `;
                
                const displayRoi = item.cost > 0 ? item.roi.toFixed(2) : 'âˆ';
                const roiClass = item.cost > 0 ? getRoiColor(item.roi) : 'col-gray';
                
                rightInfo = `
                    <div class="r-val-main ${roiClass}">${displayRoi}</div>
                    <div class="r-val-sub">å‡€æ”¶${fmtMoney(item.amt)} / èŠ±è´¹${fmtMoney(item.cost)}</div>
                    <div class="r-val-ter">é€€æ¬¾${fmtMoney(item.refund)} (${item.rate.toFixed(1)}%)</div>
                `;
                
                const maxVal = Math.max(item.amt, item.cost);
                const wAmt = maxVal ? (item.amt/maxVal*100) : 0;
                const wCost = maxVal ? (item.cost/maxVal*100) : 0;
                barHtml = `<div class="bar-wrap"><div style="width:${wAmt}%;background:#1890ff"></div></div>
                           <div class="bar-wrap" style="margin-top:2px;height:4px"><div style="width:${wCost}%;background:#ff4d4f"></div></div>`;

            } else {
                gridStyle = 'grid-template-columns: 85px 45px 45px 55px 1fr 1fr 1fr;';
                headerCells = `
                    <span class="cell-left">åŸå¸‚</span>
                    <span class="cell-center">ä¹°å®¶</span>
                    <span class="cell-center">é€€å®¢</span>
                    <span class="cell-right">é€€å®¢ç‡</span>
                    <span class="cell-right">æ€»æ”¯ä»˜</span>
                    <span class="cell-right">å‡€å®æ”¶</span>
                    <span class="cell-right">é€€æ¬¾é¢</span>
                `;
                
                const rateColor = item.rate > 10 ? 'text-red' : 'col-gray';
                rightInfo = `
                    <div class="r-val-main">${fmtMoney(item.amt)}</div>
                    <div class="r-val-sub">é€€æ¬¾ ${fmtMoney(item.refund)}</div>
                    <div class="r-val-ter ${rateColor}">é€€ç‡ ${item.rate.toFixed(1)}%</div>
                `;
                barHtml = `<div class="bar-wrap"><div style="width:${Math.min(item.rate, 100)}%;background:#ff4d4f"></div></div>`;
            }

            const cityHtml = item.cities.map(c => {
                let cCols = '';
                const cRateColor = c.rate > 10 ? 'col-red' : 'col-gray';
                
                if (showRoi) {
                    const cDispRoi = c.cost > 0 ? c.roi.toFixed(2) : 'âˆ';
                    const cColor = c.cost > 0 ? getRoiColor(c.roi) : 'col-gray';
                    cCols = `<div class="cell-center c-count-red">${c.refundCount}</div>
                             <div class="cell-right ${cRateColor}">${c.rate.toFixed(0)}%</div>
                             <div class="cell-right c-num">${Math.round(c.amt + c.refund)}</div>
                             <div class="cell-right c-num c-bold">${Math.round(c.amt)}</div>
                             <div class="cell-right c-num c-gray">${Math.round(c.refund)}</div>
                             <div class="cell-right c-num col-red">${Math.round(c.cost)}</div>
                             <div class="cell-right c-bold" style="color:${cColor}">${cDispRoi}</div>`;
                } else {
                    cCols = `<div class="cell-center c-count-red">${c.refundCount}</div>
                             <div class="cell-right c-bold" style="color:${cRateColor}">${c.rate.toFixed(1)}%</div>
                             <div class="cell-right c-num">${Math.round(c.amt + c.refund)}</div>
                             <div class="cell-right c-num c-bold">${Math.round(c.amt)}</div>
                             <div class="cell-right c-num col-red">${Math.round(c.refund)}</div>`;
                }

                // æ–°å¢ï¼šåŸå¸‚åç§°åŠå…¶å³ä¾§çš„å¤åˆ¶æŒ‰é’®
                return `
                    <div class="grid-row" style="${gridStyle}">
                        <div class="c-name cell-left">
                            ${c.name}
                            <span class="btn-copy" onclick="copyText('${c.name}', event)" title="å¤åˆ¶åŸå¸‚å">ğŸ“‹</span>
                        </div>
                        <div class="c-count cell-center">${c.count}</div>
                        ${cCols}
                    </div>
                `;
            }).join('');

            const div = document.createElement('div');
            div.innerHTML = `
                <div class="row" onclick="this.classList.toggle('open')">
                    <div class="r-main">
                        <div class="r-left">
                            <div class="${rankClass}">${idx + 1}</div>
                            <div class="r-name">${item.name}</div>
                            <div class="r-buyer-tag">ğŸ‘¤ ${item.count} <span style="color:#ff4d4f;margin-left:4px;font-weight:bold;">é€€ ${item.refundCount}</span></div>
                        </div>
                        <div class="r-right">${rightInfo}</div>
                    </div>
                    ${barHtml}
                    <div class="detail-box">
                        <div class="grid-row head" style="${gridStyle}">${headerCells}</div>
                        ${cityHtml}
                    </div>
                </div>
            `;
            box.appendChild(div);
        });
    }

    function renderChart(list, showRoi) {
        const top10 = list.slice(0, 10);
        myChart = echarts.init($('chart-box'));
        let series = [];
        if (showRoi) {
            series = [
                { name: 'èŠ±è´¹', type: 'bar', data: top10.map(i => i.cost), itemStyle:{color:'#ff4d4f', borderRadius:[4,4,0,0]} },
                { name: 'å‡€äº§å‡º', type: 'bar', data: top10.map(i => i.amt), itemStyle:{color:'#1890ff', borderRadius:[4,4,0,0]} }
            ];
        } else {
            series = [
                { name: 'å‡€å®æ”¶', type: 'bar', data: top10.map(i => i.amt), itemStyle:{color:'#1890ff', borderRadius:[4,4,0,0]} },
                { name: 'é€€æ¬¾é¢', type: 'line', data: top10.map(i => i.refund), itemStyle:{color:'#ff4d4f'} }
            ];
        }
        myChart.setOption({
            tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
            legend: { bottom: 0 },
            grid: { left: '3%', right: '4%', bottom: '10%', containLabel: true },
            xAxis: { type: 'category', data: top10.map(i => i.name) },
            yAxis: { type: 'value' },
            series: series
        });
        
        window.addEventListener('resize', () => {
            if (myChart) myChart.resize();
        });
    }

    // --- æ–°å¢ï¼šå¯¼å‡ºæŠ¥è¡¨åŠŸèƒ½ ---
    function exportReport() {
        if (!currentDisplayList || currentDisplayList.length === 0) {
            showToast("âš ï¸ å½“å‰æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æ•°æ®å¯å¯¼å‡º");
            return;
        }

        const exportData = [];

        currentDisplayList.forEach(p => {
            p.cities.forEach(c => {
                const row = {
                    'çœä»½': p.name,
                    'åŸå¸‚': c.name,
                    'ä¹°å®¶æ•°': c.count,
                    'é€€å®¢æ•°': c.refundCount,
                    'é€€å®¢ç‡(%)': parseFloat(c.rate.toFixed(2)),
                    'æ€»æ”¯ä»˜': Math.round(c.amt + c.refund),
                    'å‡€å®æ”¶': Math.round(c.amt),
                    'é€€æ¬¾é¢': Math.round(c.refund)
                };

                if (globalShowRoi) {
                    row['èŠ±è´¹'] = Math.round(c.cost);
                    row['ROI'] = c.cost > 0 ? parseFloat(c.roi.toFixed(2)) : 'âˆ';
                }

                exportData.push(row);
            });
        });

        try {
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "ç­›é€‰ååœ°åŸŸæ˜ç»†");
            
            const timeStr = new Date().toISOString().slice(0,10).replace(/-/g, "");
            XLSX.writeFile(wb, `åœ°åŸŸæŠ¥è¡¨å¯¼å‡º_${timeStr}.xlsx`);
            
            showToast("âœ… æŠ¥è¡¨å·²æˆåŠŸå¯¼å‡ºä¸‹è½½ï¼");
        } catch (err) {
            console.error(err);
            showToast("âŒ å¯¼å‡ºå¤±è´¥");
        }
    }

    function getRoiColor(val) {
        if(val < 1) return '#ff4d4f'; 
        if(val < 3) return '#fa8c16'; 
        return '#52c41a'; 
    }
</script>
</body>
</html>