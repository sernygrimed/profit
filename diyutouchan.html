<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ROI å‡€å®æ”¶æ ¸ç®— (V11.0)</title>
    <!-- å¼•å…¥ SheetJS ç”¨äºè§£æ Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <!-- å¼•å…¥ ECharts ç”¨äºå›¾è¡¨å±•ç¤º -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        /* --- åŸºç¡€é‡ç½® --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif; background: #f5f7fa; margin: 0; padding: 12px; color: #333; }
        
        .container { max-width: 900px; margin: 0 auto; }
        .card { background: #fff; border-radius: 12px; padding: 16px; margin-bottom: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.04); }
        
        /* --- å¤´éƒ¨ --- */
        .header { text-align: center; padding: 20px 10px; }
        .header h2 { margin: 0 0 6px 0; color: #1890ff; font-size: 20px; font-weight: 800; letter-spacing: -0.5px; }
        .header p { margin: 0; color: #666; font-size: 12px; opacity: 0.8; }
        .tag-version { background: #e6f7ff; color: #1890ff; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; vertical-align: top; margin-left: 4px; }

        /* --- ä¸Šä¼ åŒºåŸŸ --- */
        .upload-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px; }
        .upload-box { 
            border: 2px dashed #e0e0e0; border-radius: 10px; padding: 15px 5px; text-align: center; 
            background: #fafafa; position: relative; transition: all 0.2s; cursor: pointer; min-height: 120px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .upload-box:active { transform: scale(0.98); background: #f0f0f0; }
        .upload-box.done { border-color: #52c41a; background: #f6ffed; }
        .upload-box.loading { border-color: #1890ff; background: #e6f7ff; cursor: wait; }
        
        .u-icon { font-size: 28px; margin-bottom: 6px; }
        .u-title { font-weight: bold; font-size: 14px; color: #333; margin-bottom: 4px; }
        .u-desc { font-size: 11px; color: #999; line-height: 1.4; }
        .u-tag { font-size: 10px; background: #eee; padding: 1px 5px; border-radius: 4px; color: #666; margin-left: 4px; vertical-align: middle; }
        .u-highlight { color: #1890ff; font-weight: bold; }
        .file-input { position: absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor: pointer; }

        /* --- æŒ‰é’® --- */
        .action-area { text-align: center; margin-top: 20px; display: flex; flex-direction: column; align-items: center; gap: 12px; }
        .btn-analyze {
            background: #e0e0e0; color: #999; border: none; padding: 12px 40px; 
            border-radius: 50px; font-size: 15px; font-weight: bold; cursor: not-allowed;
            box-shadow: none; transition: 0.3s; width: 100%; max-width: 300px;
        }
        .btn-analyze.active {
            background: linear-gradient(135deg, #1890ff, #096dd9); color: white;
            cursor: pointer; box-shadow: 0 8px 24px rgba(24, 144, 255, 0.3);
        }
        .btn-analyze.active:active { transform: scale(0.98); }

        /* æ–°å¢ï¼šé‡ç½®æŒ‰é’®æ ·å¼ */
        .btn-reset {
            background: transparent; border: 1px solid #d9d9d9; color: #666;
            padding: 8px 24px; border-radius: 50px; font-size: 13px;
            cursor: pointer; transition: 0.3s; display: none; /* é»˜è®¤éšè— */
        }
        .btn-reset:hover { border-color: #ff4d4f; color: #ff4d4f; background: #fff1f0; }

        /* --- KPI æŒ‡æ ‡å¡ --- */
        .kpi-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; text-align: center; margin-bottom: 8px; }
        .kpi-item { background: #f8f9fa; padding: 10px 5px; border-radius: 8px; }
        .kpi-val { font-size: 16px; font-weight: 800; color: #333; display: block; margin-bottom: 4px; font-family: 'DIN Alternate', sans-serif; }
        .kpi-lbl { font-size: 11px; color: #888; white-space: nowrap; }
        .text-red { color: #ff4d4f; }
        .text-blue { color: #1890ff; }
        .text-green { color: #52c41a; }
        .text-orange { color: #fa8c16; }

        /* --- åˆ—è¡¨éƒ¨åˆ† --- */
        .list-header { display: flex; justify-content: space-between; padding-bottom: 10px; border-bottom: 2px solid #f0f0f0; color: #999; font-size: 12px; font-weight: bold; }
        
        /* çœä»½è¡Œ */
        .row { border-bottom: 1px solid #f5f5f5; padding: 14px 0; cursor: pointer; transition: background 0.1s; }
        .row:hover { background: #fafafa; }
        
        .r-main { display: flex; align-items: flex-start; justify-content: space-between; }
        
        /* å·¦ä¾§ */
        .r-left { display: flex; align-items: center; gap: 8px; flex: 1; min-width: 0; padding-top: 4px; }
        .r-idx { width: 20px; height: 20px; background: #eee; color: #999; text-align: center; line-height: 20px; border-radius: 6px; font-size: 11px; font-weight: 700; flex-shrink: 0; }
        .r-idx.top { background: #fff1f0; color: #ff4d4f; }
        .r-name { font-size: 15px; font-weight: 700; color: #333; white-space: nowrap; }
        .r-buyer-tag { font-size: 11px; color: #888; background: #f5f5f5; padding: 2px 6px; border-radius: 10px; display: flex; align-items: center; gap: 4px; white-space: nowrap; }
        
        /* å³ä¾§ (å¤šè¡Œæ•°æ®) */
        .r-right { text-align: right; flex-shrink: 0; margin-left: 10px; }
        .r-val-main { font-family: 'DIN Alternate', sans-serif; font-weight: 700; font-size: 18px; line-height: 1.2; }
        .r-val-sub { font-size: 11px; color: #666; margin-top: 2px; display: block; }
        .r-val-ter { font-size: 10px; color: #999; margin-top: 1px; display: block; }
        
        /* --- åŸå¸‚æ˜ç»†ç›’å­ --- */
        .detail-box { display: none; background: #fcfcfc; padding: 8px; border: 1px solid #eee; margin-top: 10px; border-radius: 8px; overflow-x: auto; }
        .row.open .detail-box { display: block; animation: slideDown 0.2s; }
        
        /* --- åŸå¸‚è¡Œ Grid å¸ƒå±€ (åŠ¨æ€åˆ—) --- */
        .grid-row { 
            display: grid; 
            gap: 2px; 
            align-items: center; 
            padding: 8px 0; 
            border-bottom: 1px dashed #f0f0f0; 
            font-size: 11px; 
            color: #666; 
        }
        
        /* è¡¨å¤´æ ·å¼ */
        .grid-row.head { 
            font-weight: bold; 
            color: #999; 
            font-size: 10px; 
            border-bottom: 2px solid #eee; 
            padding-bottom: 6px; 
            margin-bottom: 4px; 
            background: #f9f9f9;
            border-radius: 4px 4px 0 0;
        }
        
        /* å•å…ƒæ ¼é€šç”¨æ ·å¼ */
        .cell { overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .cell-left { text-align: left; }
        .cell-center { text-align: center; }
        .cell-right { text-align: right; }
        
        /* ç‰¹å®šåˆ—æ ·å¼ */
        .c-name { font-weight: 500; color: #333; }
        .c-count { font-family: 'DIN Alternate', monospace; background: #f0f0f0; border-radius: 4px; color: #666; font-size: 10px; padding: 1px 0; }
        .c-num { font-family: 'DIN Alternate', monospace; }
        .c-bold { font-weight: bold; color: #333; }
        
        /* è¿›åº¦æ¡ */
        .bar-wrap { height: 6px; background: #f0f0f0; border-radius: 3px; overflow: hidden; display: flex; margin-top: 8px; }
        
        /* é¢œè‰²ç±» */
        .col-red { color: #ff4d4f; }
        .col-green { color: #52c41a; }
        .col-gray { color: #ccc; }
        .col-orange { color: #fa8c16; }

        .spinner { width: 20px; height: 20px; border: 3px solid rgba(24,144,255,0.2); border-top-color: #1890ff; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <div class="card header">
        <h2>ğŸ’° ROI å‡€å®æ”¶æ ¸ç®— <span class="tag-version">V11.0</span></h2>
        <p>å®æ”¶ = å–å®¶å®æ”¶ - é€€æ¬¾é‡‘é¢ | å‰”é™¤è™šé«˜äº§å‡º</p>
        
        <div class="upload-grid">
            <div class="upload-box" id="box-order">
                <div id="icon-order" class="u-icon">ğŸ“¦</div>
                <div class="u-title" id="txt-order">è®¢å•æŠ¥è¡¨</div>
                <div class="u-desc" id="desc-order">æå– <span class="u-highlight">å®æ”¶ & é€€æ¬¾</span></div>
                <input type="file" id="fileOrder" class="file-input" accept=".xlsx, .xls, .csv">
            </div>
            <div class="upload-box" id="box-ad">
                <div id="icon-ad" class="u-icon">ğŸ“¢</div>
                <div class="u-title" id="txt-ad">æ¨å¹¿æŠ¥è¡¨<span class="u-tag">å¯é€‰</span></div>
                <div class="u-desc" id="desc-ad">å¦‚æœ‰æ¨å¹¿æ•°æ®<br>è‡ªåŠ¨è®¡ç®— ROI</div>
                <input type="file" id="fileAd" class="file-input" accept=".xlsx, .xls, .csv">
            </div>
        </div>

        <div class="action-area">
            <button id="btn-analyze" class="btn-analyze" disabled>è¯·è‡³å°‘ä¸Šä¼ è®¢å•è¡¨</button>
            <button id="btn-reset" class="btn-reset">ğŸ—‘ï¸ æ¸…ç©ºé‡ç½®</button>
        </div>
        <p id="status-msg" style="text-align:center;color:#999;font-size:12px;margin-top:10px;height:20px;"></p>
    </div>

    <div id="result-area" style="display: none;">
        <!-- KPI çœ‹æ¿ -->
        <div class="card">
            <div class="kpi-row">
                <div class="kpi-item">
                    <span class="kpi-val text-blue" id="k-amt">0</span>
                    <span class="kpi-lbl">å‡€å®æ”¶æ€»é¢</span>
                </div>
                <div class="kpi-item">
                    <span class="kpi-val text-red" id="k-cost">0</span>
                    <span class="kpi-lbl" id="lbl-cost">é€€æ¬¾æ€»é¢</span>
                </div>
                <div class="kpi-item">
                    <span class="kpi-val text-green" id="k-roi">0</span>
                    <span class="kpi-lbl" id="lbl-roi">é€€æ¬¾é‡‘é¢ç‡</span>
                </div>
            </div>
            <div class="kpi-row">
                <div class="kpi-item">
                    <span class="kpi-val" id="k-orders">0</span>
                    <span class="kpi-lbl">ä¹°å®¶æ•°(å»é‡)</span>
                </div>
                <!-- å ä½ï¼Œä¿æŒå¸ƒå±€æ•´é½ -->
                <div class="kpi-item" style="background:transparent;"></div>
                <div class="kpi-item" style="background:transparent;"></div>
            </div>
        </div>

        <div class="card">
            <div id="chart-box" style="height:300px;width:100%"></div>
        </div>

        <div class="card">
            <div class="list-header">
                <span id="list-title">åŒºåŸŸæ’è¡Œ</span>
                <span id="list-cols">æ•°æ®æ¦‚è§ˆ</span>
            </div>
            <div id="list-box"></div>
        </div>
    </div>
</div>

<script>
    const $ = id => document.getElementById(id);
    const fmtMoney = n => 'Â¥' + Math.round(n).toLocaleString();
    const cleanStr = str => String(str || '').trim().replace(/[\ufeff\s"]/g, '');
    
    const normalizeAddr = name => {
        if (!name) return '';
        let str = String(name).trim();
        if (str === '-' || str === 'æœªçŸ¥') return '';
        ['çœ', 'ç»´å¾å°”è‡ªæ²»åŒº', 'å£®æ—è‡ªæ²»åŒº', 'å›æ—è‡ªæ²»åŒº', 'è‡ªæ²»åŒº', 'ç‰¹åˆ«è¡Œæ”¿åŒº'].forEach(s => {
            if (str.endsWith(s) && str.length > 2) str = str.replace(s, '');
        });
        if(str.endsWith('å¸‚') && str.length <= 4) str = str.replace('å¸‚', '');
        return str;
    };

    const getCleanCityName = (city, province) => {
        if (!city || !province) return city;
        if (city.startsWith(province) && city.length > province.length) return city.replace(province, '');
        const provWithSuffix = province + 'çœ';
        if (city.startsWith(provWithSuffix)) return city.replace(provWithSuffix, '');
        return city;
    };

    let orderData = null;
    let adData = null;
    let myChart = null; // Chart instance

    $('fileOrder').addEventListener('change', e => startProcess(e.target, 'order'));
    $('fileAd').addEventListener('change', e => startProcess(e.target, 'ad'));
    $('btn-analyze').addEventListener('click', mergeAndAnalyze);
    $('btn-reset').addEventListener('click', resetAll);

    function startProcess(input, type) {
        const file = input.files[0];
        if(!file) return;
        const box = $(type === 'order' ? 'box-order' : 'box-ad');
        const icon = $(type === 'order' ? 'icon-order' : 'icon-ad');
        box.className = 'upload-box loading';
        icon.innerHTML = '<div class="spinner"></div>';
        $('status-msg').innerText = `æ­£åœ¨è§£æ: ${file.name}`;
        $('status-msg').style.color = '#999';
        
        setTimeout(() => {
            if (file.name.endsWith('.csv')) parseCSV(file, type);
            else parseExcel(file, type);
        }, 50);
    }

    function parseCSV(file, type) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const buffer = e.target.result;
            let text = '';
            const decoderUTF = new TextDecoder('utf-8');
            const strUTF = decoderUTF.decode(buffer);
            const keywords = type === 'order' ? ['è®¢å•', 'é‡‘é¢', 'å®æ”¶'] : ['èŠ±è´¹', 'çœ', 'åœ°åŸŸ', 'æ¶ˆè€—'];
            const isUTFValid = keywords.some(k => strUTF.includes(k));
            if (isUTFValid) text = strUTF;
            else {
                const decoderGBK = new TextDecoder('gbk');
                text = decoderGBK.decode(buffer);
            }
            const rows = csvToJson(text);
            processData(rows, type);
        };
        reader.readAsArrayBuffer(file);
    }

    function csvToJson(text) {
        const lines = text.split(/\r\n|\n/);
        const result = [];
        if (lines.length < 2) return [];
        const headers = lines[0].split(',').map(h => cleanStr(h));
        for (let i = 1; i < lines.length; i++) {
            if (!lines[i].trim()) continue;
            const row = lines[i].split(','); 
            if (row.length < headers.length) continue;
            const obj = {};
            headers.forEach((h, idx) => { obj[h] = row[idx] ? cleanStr(row[idx]) : ''; });
            result.push(obj);
        }
        return result;
    }

    function parseExcel(file, type) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(sheet, { defval: "" });
            processData(json, type);
        };
        reader.readAsArrayBuffer(file);
    }

    function processData(data, type) {
        try {
            const keys = Object.keys(data[0]);
            
            if (type === 'order') {
                const cProv = keys.find(k => k.includes('çœ'));
                const cCity = keys.find(k => k.includes('å¸‚') || k.includes('åŸ'));
                
                let cAmt = keys.find(k => cleanStr(k) === 'å–å®¶å®æ”¶');
                if (!cAmt) cAmt = keys.find(k => k.includes('å®æ”¶') || k.includes('é‡‘é¢'));
                
                let cOid = keys.find(k => k.includes('åŸå§‹çº¿ä¸Šè®¢å•å·'));
                if (!cOid) cOid = keys.find(k => k.includes('çº¿ä¸Šè®¢å•å·') || k.includes('è®¢å•å·'));

                let cRef = keys.find(k => k.includes('é€€æ¬¾'));

                if (!cAmt) throw new Error("æœªæ‰¾åˆ°ã€å–å®¶å®æ”¶ã€‘åˆ—");

                let totalNetAmt = 0; // å‡€å®æ”¶
                let totalRefund = 0;
                let validOrders = new Set();
                const map = {};

                data.forEach(row => {
                    const received = parseFloat(String(row[cAmt]).replace(/,/g, ''));
                    if (isNaN(received)) return;

                    let refund = 0;
                    if(cRef) {
                        const r = parseFloat(String(row[cRef]).replace(/,/g, ''));
                        if(!isNaN(r)) refund = r;
                    }

                    // è®¡ç®—å‡€å®æ”¶: å–å®¶å®æ”¶ - é€€æ¬¾
                    const netAmt = received - refund;

                    const prov = normalizeAddr(row[cProv]);
                    const city = normalizeAddr(row[cCity]);
                    const oid = row[cOid]; 

                    if (!prov || prov === 'æœªçŸ¥') return;

                    if (!map[prov]) map[prov] = { amt: 0, refund: 0, orders: new Set(), cities: {} };
                    
                    let rawCityName = row[cCity] ? String(row[cCity]).trim() : city;
                    if (!map[prov].cities[city]) {
                        map[prov].cities[city] = { amt: 0, refund: 0, orders: new Set(), rawName: rawCityName };
                    }

                    map[prov].amt += netAmt; // å­˜å‚¨å‡€å®æ”¶
                    map[prov].refund += refund;
                    map[prov].cities[city].amt += netAmt; // å­˜å‚¨å‡€å®æ”¶
                    map[prov].cities[city].refund += refund;
                    
                    totalNetAmt += netAmt;
                    totalRefund += refund;

                    if (oid) {
                        map[prov].orders.add(oid);
                        map[prov].cities[city].orders.add(oid);
                        validOrders.add(oid);
                    }
                });
                
                orderData = { total: totalNetAmt, totalRefund, count: validOrders.size, map };
                updateStatus('box-order', 'icon-order', 'ğŸ“¦', `å‡€å®æ”¶${fmtMoney(totalNetAmt)} | ${validOrders.size}äºº`);

            } else {
                // æ¨å¹¿æŠ¥è¡¨é€»è¾‘ä¸å˜
                const cProv = keys.find(k => k.includes('çœ') || k.includes('åœ°åŸŸ'));
                const cCity = keys.find(k => k.includes('å¸‚') || k.includes('åŸ'));
                const cCost = keys.find(k => k.includes('èŠ±è´¹') || k.includes('æ¶ˆè€—'));

                if (!cCost) throw new Error("æœªæ‰¾åˆ°ã€èŠ±è´¹ã€‘åˆ—");

                let total = 0;
                const map = {};

                data.forEach(row => {
                    const cost = parseFloat(String(row[cCost]).replace(/,/g, ''));
                    if (isNaN(cost)) return;

                    const prov = normalizeAddr(row[cProv]);
                    const city = normalizeAddr(row[cCity]);
                    if (!prov || prov === 'æœªçŸ¥') return;

                    if (!map[prov]) map[prov] = { cost: 0, cities: {} };
                    if (!map[prov].cities[city]) map[prov].cities[city] = 0;

                    map[prov].cost += cost;
                    map[prov].cities[city] += cost;
                    total += cost;
                });
                adData = { total, map };
                updateStatus('box-ad', 'icon-ad', 'ğŸ“¢', `èŠ±è´¹${fmtMoney(total)}`);
            }

            $('status-msg').innerText = "";
            checkReady();

        } catch (err) {
            console.error(err);
            // alert("è§£æé”™è¯¯: " + err.message); // æ›¿æ¢alertä»¥ç¬¦åˆå®‰å…¨è§„èŒƒ
            const box = $(type === 'order' ? 'box-order' : 'box-ad');
            box.className = 'upload-box'; 
            $('status-msg').innerText = "âŒ è§£æå¤±è´¥: " + err.message;
            $('status-msg').style.color = '#ff4d4f';
        }
    }

    function updateStatus(boxId, iconId, icon, text) {
        $(boxId).className = 'upload-box done';
        $(iconId).innerHTML = icon;
        $(boxId).querySelector('.u-title').innerHTML = text;
        $(boxId).querySelector('.u-desc').innerText = "âœ… è§£ææˆåŠŸ";
    }

    function checkReady() {
        // åªè¦æœ‰æ•°æ®ï¼Œå°±æ˜¾ç¤ºé‡ç½®æŒ‰é’®
        if (orderData || adData) {
            $('btn-reset').style.display = 'inline-block';
        }

        const btn = $('btn-analyze');
        if (orderData) {
            btn.disabled = false;
            btn.classList.add('active');
            btn.innerText = adData ? "ğŸš€ å¼€å§‹å…¨èƒ½åˆ†æ" : "ğŸš€ å¼€å§‹é”€å”®åˆ†æ";
        }
    }

    function resetAll() {
        // æ¸…ç©ºæ•°æ®
        orderData = null;
        adData = null;
        if (myChart) {
            myChart.dispose();
            myChart = null;
        }

        // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
        $('fileOrder').value = '';
        $('fileAd').value = '';

        // è¿˜åŸUI
        resetBox('box-order', 'icon-order', 'ğŸ“¦', 'è®¢å•æŠ¥è¡¨', 'æå– <span class="u-highlight">å®æ”¶ & é€€æ¬¾</span>');
        resetBox('box-ad', 'icon-ad', 'ğŸ“¢', 'æ¨å¹¿æŠ¥è¡¨<span class="u-tag">å¯é€‰</span>', 'å¦‚æœ‰æ¨å¹¿æ•°æ®<br>è‡ªåŠ¨è®¡ç®— ROI');

        // è¿˜åŸæŒ‰é’®
        const btn = $('btn-analyze');
        btn.disabled = true;
        btn.classList.remove('active');
        btn.innerText = "è¯·è‡³å°‘ä¸Šä¼ è®¢å•è¡¨";
        btn.style.background = '#e0e0e0';

        // éšè—åŒºåŸŸ
        $('btn-reset').style.display = 'none';
        $('result-area').style.display = 'none';
        $('status-msg').innerText = '';
        $('list-box').innerHTML = '';
    }

    function resetBox(boxId, iconId, iconChar, titleHtml, descHtml) {
        const box = $(boxId);
        box.className = 'upload-box';
        $(iconId).innerHTML = iconChar;
        box.querySelector('.u-title').innerHTML = titleHtml;
        box.querySelector('.u-desc').innerHTML = descHtml;
    }

    function mergeAndAnalyze() {
        $('result-area').style.display = 'block';
        $('btn-analyze').innerText = "ğŸ”„ åˆ†æå®Œæˆ";
        $('btn-analyze').style.background = '#87d068';
        $('btn-analyze').disabled = true;

        // KPI Update
        $('k-amt').innerText = fmtMoney(orderData.total);
        $('k-orders').innerText = orderData.count.toLocaleString();
        
        if (adData) {
            $('lbl-cost').innerText = "æ¨å¹¿èŠ±è´¹";
            $('k-cost').innerText = fmtMoney(adData.total);
            const globalRoi = adData.total > 0 ? (orderData.total / adData.total).toFixed(2) : 'âˆ';
            $('lbl-roi').innerText = "æ•´ä½“ ROI";
            $('k-roi').innerText = globalRoi;
            $('k-roi').className = 'kpi-val ' + getRoiColor(orderData.total / adData.total);
            $('list-title').innerText = "åŒºåŸŸ (æŒ‰èŠ±è´¹é™åº)";
            $('list-cols').innerText = "ROI / å‡€å®æ”¶ / èŠ±è´¹";
        } else {
            $('lbl-cost').innerText = "é€€æ¬¾æ€»é¢";
            $('k-cost').innerText = fmtMoney(orderData.totalRefund);
            // é”€å”®æ€»é¢(GMV-like) = å‡€å®æ”¶ + é€€æ¬¾
            const gmv = orderData.total + orderData.totalRefund;
            const refRate = gmv > 0 ? (orderData.totalRefund / gmv * 100).toFixed(2) : 0;
            
            $('lbl-roi').innerText = "é€€æ¬¾é‡‘é¢ç‡";
            $('k-roi').innerText = refRate + '%';
            $('k-roi').className = 'kpi-val ' + (refRate > 20 ? 'text-red' : (refRate > 10 ? 'text-orange' : 'text-green'));
            $('list-title').innerText = "åŒºåŸŸ (æŒ‰å‡€å®æ”¶é™åº)";
            $('list-cols').innerText = "é€€æ¬¾ / å æ¯” / å‡€å®æ”¶";
        }

        // Data Merge
        const allProvs = new Set([...Object.keys(orderData.map), ...(adData ? Object.keys(adData.map) : [])]);
        const list = [];

        allProvs.forEach(p => {
            const o = orderData.map[p] || { amt: 0, refund: 0, orders: new Set(), cities: {} };
            const a = (adData && adData.map[p]) ? adData.map[p] : { cost: 0, cities: {} };
            
            const allCities = new Set([...Object.keys(o.cities), ...Object.keys(a.cities)]);
            const cityList = [];
            
            allCities.forEach(c => {
                const cData = o.cities[c] || { amt: 0, refund: 0, orders: new Set(), rawName: c };
                const cAmt = cData.amt; // å‡€å®æ”¶
                const cRefund = cData.refund;
                const cCost = a.cities[c] || 0;
                const cCount = cData.orders.size;

                if (cAmt === 0 && cCost === 0 && cRefund === 0) return;
                
                // ROI = å‡€å®æ”¶ / èŠ±è´¹
                const roi = cCost > 0 ? cAmt / cCost : (cAmt > 0 ? 999 : 0);
                
                // é€€æ¬¾ç‡ = é€€æ¬¾ / (å‡€å®æ”¶ + é€€æ¬¾)
                const cityGmv = cAmt + cRefund;
                const rate = cityGmv > 0 ? (cRefund / cityGmv * 100) : 0;
                
                let rawCity = cData.rawName || c;
                let displayName = getCleanCityName(rawCity, p);
                if (displayName === rawCity) displayName = getCleanCityName(c, p);

                cityList.push({ name: displayName, amt: cAmt, refund: cRefund, rate: rate, cost: cCost, count: cCount, roi: roi });
            });
            
            if (adData) cityList.sort((x, y) => y.cost - x.cost);
            else cityList.sort((x, y) => y.amt - x.amt);

            const pRoi = a.cost > 0 ? o.amt / a.cost : (o.amt > 0 ? 999 : 0);
            const provGmv = o.amt + o.refund;
            const pRate = provGmv > 0 ? (o.refund / provGmv * 100) : 0;
            
            list.push({ 
                name: p, 
                amt: o.amt, 
                refund: o.refund,
                rate: pRate,
                cost: a.cost, 
                count: o.orders.size, 
                roi: pRoi, 
                cities: cityList 
            });
        });

        if (adData) list.sort((a, b) => b.cost - a.cost);
        else list.sort((a, b) => b.amt - a.amt);

        renderList(list, !!adData);
        renderChart(list, !!adData);
        
        setTimeout(() => $('result-area').scrollIntoView({behavior: "smooth"}), 100);
    }

    function renderList(list, showRoi) {
        const box = $('list-box');
        box.innerHTML = '';
        list.forEach((item, idx) => {
            if (item.amt === 0 && item.cost === 0 && item.refund === 0) return;
            
            const rankClass = idx < 3 ? 'r-idx top' : 'r-idx';
            let rightInfo = '';
            let barHtml = '';
            
            // --- Header & Layout Config ---
            let headerCells = '';
            let gridStyle = ''; 

            if (showRoi) {
                // ROI Mode (7 Cols)
                gridStyle = 'grid-template-columns: 60px 40px 40px 50px 1fr 1fr 40px;';
                headerCells = `
                    <span class="cell-left">åŸå¸‚</span>
                    <span class="cell-center">ä¹°å®¶</span>
                    <span class="cell-right">é€€ç‡</span>
                    <span class="cell-right">é€€æ¬¾</span>
                    <span class="cell-right">å‡€å®æ”¶</span>
                    <span class="cell-right">èŠ±è´¹</span>
                    <span class="cell-right">ROI</span>
                `;
                
                const displayRoi = item.cost > 0 ? item.roi.toFixed(2) : 'âˆ';
                const roiClass = item.cost > 0 ? getRoiColor(item.roi) : 'col-gray';
                rightInfo = `
                    <div class="r-val-main ${roiClass}" style="font-size:20px">${displayRoi}</div>
                    <div class="r-val-sub">å‡€æ”¶${fmtMoney(item.amt)} / èŠ±è´¹${fmtMoney(item.cost)}</div>
                    <div class="r-val-ter">é€€æ¬¾${fmtMoney(item.refund)} (${item.rate.toFixed(1)}%)</div>
                `;
                
                const maxVal = Math.max(item.amt, item.cost);
                const wAmt = maxVal ? (item.amt/maxVal*100) : 0;
                const wCost = maxVal ? (item.cost/maxVal*100) : 0;
                barHtml = `<div class="bar-wrap"><div style="width:${wAmt}%;background:#1890ff"></div></div>
                           <div class="bar-wrap" style="margin-top:2px;height:4px"><div style="width:${wCost}%;background:#ff4d4f"></div></div>`;

            } else {
                // Sales Mode (5 Cols)
                gridStyle = 'grid-template-columns: 80px 50px 60px 80px 1fr;';
                headerCells = `
                    <span class="cell-left">åŸå¸‚</span>
                    <span class="cell-center">ä¹°å®¶</span>
                    <span class="cell-right">é€€æ¬¾ç‡</span>
                    <span class="cell-right">é€€æ¬¾é¢</span>
                    <span class="cell-right">å‡€å®æ”¶</span>
                `;
                
                const rateColor = item.rate > 10 ? 'text-red' : 'col-gray';
                rightInfo = `
                    <div class="r-val-main">${fmtMoney(item.amt)}</div>
                    <div class="r-val-sub">é€€æ¬¾ ${fmtMoney(item.refund)}</div>
                    <div class="r-val-ter ${rateColor}">é€€æ¬¾ç‡ ${item.rate.toFixed(1)}%</div>
                `;
                barHtml = `<div class="bar-wrap"><div style="width:${Math.min(item.rate, 100)}%;background:#ff4d4f"></div></div>`;
            }

            const cityHtml = item.cities.map(c => {
                let cCols = '';
                const cRateColor = c.rate > 10 ? 'col-red' : 'col-gray';
                
                if (showRoi) {
                    const cDispRoi = c.cost > 0 ? c.roi.toFixed(2) : 'âˆ';
                    const cColor = c.cost > 0 ? getRoiColor(c.roi) : 'col-gray';
                    cCols = `<div class="cell-right ${cRateColor}">${c.rate.toFixed(0)}%</div>
                             <div class="cell-right c-num c-gray">${Math.round(c.refund)}</div>
                             <div class="cell-right c-num c-bold">${Math.round(c.amt)}</div>
                             <div class="cell-right c-num col-red">${Math.round(c.cost)}</div>
                             <div class="cell-right c-bold" style="color:${cColor}">${cDispRoi}</div>`;
                } else {
                    cCols = `<div class="cell-right c-bold" style="color:${cRateColor}">${c.rate.toFixed(1)}%</div>
                             <div class="cell-right c-num col-red">${Math.round(c.refund)}</div>
                             <div class="cell-right c-num c-bold">${Math.round(c.amt)}</div>`;
                }

                return `
                    <div class="grid-row" style="${gridStyle}">
                        <div class="c-name cell-left">${c.name}</div>
                        <div class="c-count cell-center">${c.count}</div>
                        ${cCols}
                    </div>
                `;
            }).join('');

            const div = document.createElement('div');
            div.innerHTML = `
                <div class="row" onclick="this.classList.toggle('open')">
                    <div class="r-main">
                        <div class="r-left">
                            <div class="${rankClass}">${idx + 1}</div>
                            <div class="r-name">${item.name}</div>
                            <div class="r-buyer-tag">ğŸ‘¤ ${item.count}</div>
                        </div>
                        <div class="r-right">${rightInfo}</div>
                    </div>
                    ${barHtml}
                    <div class="detail-box">
                        <div class="grid-row head" style="${gridStyle}">${headerCells}</div>
                        ${cityHtml}
                    </div>
                </div>
            `;
            box.appendChild(div);
        });
    }

    function renderChart(list, showRoi) {
        const top10 = list.slice(0, 10);
        myChart = echarts.init($('chart-box'));
        let series = [];
        if (showRoi) {
            series = [
                { name: 'èŠ±è´¹', type: 'bar', data: top10.map(i => i.cost), itemStyle:{color:'#ff4d4f', borderRadius:[4,4,0,0]} },
                { name: 'å‡€äº§å‡º', type: 'bar', data: top10.map(i => i.amt), itemStyle:{color:'#1890ff', borderRadius:[4,4,0,0]} }
            ];
        } else {
            series = [
                { name: 'å‡€å®æ”¶', type: 'bar', data: top10.map(i => i.amt), itemStyle:{color:'#1890ff', borderRadius:[4,4,0,0]} },
                { name: 'é€€æ¬¾é¢', type: 'line', data: top10.map(i => i.refund), itemStyle:{color:'#ff4d4f'} }
            ];
        }
        myChart.setOption({
            tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
            legend: { bottom: 0 },
            grid: { left: '3%', right: '4%', bottom: '10%', containLabel: true },
            xAxis: { type: 'category', data: top10.map(i => i.name) },
            yAxis: { type: 'value' },
            series: series
        });
        window.onresize = () => myChart && myChart.resize();
    }

    function getRoiColor(val) {
        if(val < 1) return '#ff4d4f'; 
        if(val < 3) return '#fa8c16'; 
        return '#52c41a'; 
    }
</script>
</body>
</html>

