<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多竞品核心数据反推测算系统</title>
    
    <!-- 引入 React 和 ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- 引入 Babel 用于在浏览器中编译 JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 引入 Tailwind CSS 进行页面美化 -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* 隐藏滚动条但保留滚动功能 */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* 全局平滑滚动 */
        html { scroll-behavior: smooth; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 antialiased">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;

        // ==========================================
        // 图标库 (内联 SVG 组件替代 lucide-react)
        // ==========================================
        const IconBase = ({ children, className = "", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                {children}
            </svg>
        );

        const Calculator = (p) => <IconBase {...p}><rect x="4" y="2" width="16" height="20" rx="2" ry="2"></rect><line x1="8" y1="6" x2="16" y2="6"></line><line x1="16" y1="14" x2="16" y2="18"></line><path d="M16 10h.01"></path><path d="M12 10h.01"></path><path d="M8 10h.01"></path><path d="M12 14h.01"></path><path d="M8 14h.01"></path><path d="M12 18h.01"></path><path d="M8 18h.01"></path></IconBase>;
        const TrendingUp = (p) => <IconBase {...p}><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"></polyline><polyline points="16 7 22 7 22 13"></polyline></IconBase>;
        const DollarSign = (p) => <IconBase {...p}><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></IconBase>;
        const AlertCircle = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></IconBase>;
        const ShoppingCart = (p) => <IconBase {...p}><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></IconBase>;
        const MousePointerClick = (p) => <IconBase {...p}><path d="M14 4.1 12 6"/><path d="m5.1 8-2.9-.8"/><path d="m6 12-1.9 2"/><path d="M7.2 2.2 8 5.1"/><path d="M9.037 9.69a.498.498 0 0 1 .653-.653l11 4.5a.5.5 0 0 1-.074.949l-4.349 1.041a1 1 0 0 0-.74.739l-1.04 4.35a.5.5 0 0 1-.95.074z"/></IconBase>;
        const Percent = (p) => <IconBase {...p}><line x1="19" y1="5" x2="5" y2="19"></line><circle cx="6.5" cy="6.5" r="2.5"></circle><circle cx="17.5" cy="17.5" r="2.5"></circle></IconBase>;
        const Activity = (p) => <IconBase {...p}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></IconBase>;
        const Download = (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></IconBase>;
        const Upload = (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></IconBase>;
        const CheckCircle2 = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></IconBase>;
        const Plus = (p) => <IconBase {...p}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></IconBase>;
        const Trash2 = (p) => <IconBase {...p}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></IconBase>;
        const Users = (p) => <IconBase {...p}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></IconBase>;
        const RotateCcw = (p) => <IconBase {...p}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></IconBase>;
        const SplitSquareHorizontal = (p) => <IconBase {...p}><path d="M8 19H5c-1 0-2-1-2-2V7c0-1 1-2 2-2h3"/><path d="M16 5h3c1 0 2 1 2 2v10c0 1-1 2-2 2h-3"/><line x1="12" y1="4" x2="12" y2="20"/></IconBase>;
        const Eye = (p) => <IconBase {...p}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></IconBase>;
        const EyeOff = (p) => <IconBase {...p}><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></IconBase>;


        // ==========================================
        // 核心逻辑与引擎
        // ==========================================
        const defaultInputs = {
          days: '30',         // 统计天数
          dailyRevenue: '',   // 日均营业额
          dailyAdSpend: '',   // 日推广付费
          pv: '',             // 整体IPV
          cvr: '',            // 转化率 
          totalOrders: '',    // 成交笔数 
          aov: '',            // 客单价 
          paidClicks: '',     // 付费点击量 
          ppc: '',            // 单次点击成本 
          margin: '',         // 预估毛利率 % 
          returnRate: '',     // 预估退货率 % 
          fixedCosts: ''      // 固定运营成本
        };

        // 模糊区间解析引擎
        const parseFuzzy = (val) => {
          if (!val) return { min: 0, max: 0, mid: 0, isRange: false };
          const str = String(val).replace(/,/g, '').replace(/%/g, '').trim().toLowerCase();
          const parts = str.split(/[-~到]/);
          
          const extractNum = (p) => {
              let multiplier = 1;
              if (p.includes('万') || p.includes('w')) multiplier = 10000;
              let num = parseFloat(p.replace(/[^0-9.]/g, ''));
              if (isNaN(num)) return 0;
              return num * multiplier;
          };

          if (parts.length === 2) {
              let p1 = extractNum(parts[0]);
              let p2 = extractNum(parts[1]);
              
              if (p2 >= 10000 && p1 > 0 && p1 < 1000 && !parts[0].includes('w') && !parts[0].includes('万')) {
                  p1 *= 10000;
              }
              if (p1 >= 10000 && p2 > 0 && p2 < 1000 && !parts[1].includes('w') && !parts[1].includes('万')) {
                  p2 *= 10000;
              }
              
              let min = Math.min(p1, p2);
              let max = Math.max(p1, p2);
              return { min, max, mid: (min + max) / 2, isRange: true };
          } else {
              let num = extractNum(str);
              return { min: num, max: num, mid: num, isRange: false };
          }
        };


        // ==========================================
        // App 主组件
        // ==========================================
        const App = () => {
          const [competitors, setCompetitors] = useState([
            { id: '1', name: '竞品 1', inputs: { ...defaultInputs } }
          ]);
          const [activeId, setActiveId] = useState('1'); 
          const [toast, setToast] = useState({ show: false, message: '', type: 'success' });
          const [showProfit, setShowProfit] = useState(true); // 控制利润显示的 State

          const activeCompetitor = competitors.find(c => c.id === activeId) || competitors[0];
          const inputs = activeCompetitor.inputs;

          const showToast = (message, type = 'success') => {
            setToast({ show: true, message, type });
            setTimeout(() => { setToast({ show: false, message: '', type: 'success' }); }, 3000);
          };

          const handleClearAll = () => {
            if(window.confirm('确定要清空所有页面和数据吗？')) {
                const newId = Date.now().toString();
                setCompetitors([{ id: newId, name: '竞品 1', inputs: { ...defaultInputs } }]);
                setActiveId(newId);
                showToast('所有数据已一键清空');
            }
          };

          const handleClearCurrent = () => {
            setCompetitors(prev => prev.map(comp => 
              comp.id === activeId ? { ...comp, inputs: { ...defaultInputs } } : comp
            ));
            showToast('当前竞品数据已清空');
          };

          const handleAddCompetitor = () => {
            const newId = Date.now().toString();
            const newName = `竞品 ${competitors.length + 1}`;
            setCompetitors([...competitors, { id: newId, name: newName, inputs: { ...defaultInputs } }]);
            setActiveId(newId);
          };

          const handleDeleteCompetitor = (e, id) => {
            e.stopPropagation(); 
            if (competitors.length === 1) {
              showToast('至少需要保留一个竞品进行测算', 'error');
              return;
            }
            const newCompetitors = competitors.filter(c => c.id !== id);
            setCompetitors(newCompetitors);
            if (activeId === id) setActiveId(newCompetitors[newCompetitors.length - 1].id);
          };

          const handleExport = () => {
            try {
              const dataStr = JSON.stringify(competitors, null, 2);
              const blob = new Blob([dataStr], { type: "application/json" });
              const url = URL.createObjectURL(blob);
              const link = document.createElement("a");
              link.href = url;
              link.download = `competitor_data_${new Date().toISOString().slice(0,10)}.json`;
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              URL.revokeObjectURL(url);
              showToast('配置导出成功！');
            } catch (err) {
              showToast('导出失败，请重试', 'error');
            }
          };

          const handleImport = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
              try {
                const parsedData = JSON.parse(event.target.result);
                if (Array.isArray(parsedData) && parsedData.length > 0 && 'inputs' in parsedData[0]) {
                   setCompetitors(parsedData);
                   setActiveId(parsedData[0].id);
                   showToast('多竞品配置导入成功！');
                } else {
                   showToast('文件格式不匹配', 'error');
                }
              } catch (error) {
                showToast('解析文件失败，请确保是有效的JSON格式', 'error');
              }
            };
            reader.readAsText(file);
            e.target.value = null; 
          };

          const handleInputChange = (e) => {
            const { name, value } = e.target;
            const strValue = String(value).trim();

            setCompetitors(prev => prev.map(comp => {
              if (comp.id !== activeId) return comp;

              const newInputs = { ...comp.inputs, [name]: strValue };

              const pv = parseFuzzy(newInputs.pv);
              const cvr = parseFuzzy(newInputs.cvr);
              const orders = parseFuzzy(newInputs.totalOrders);
              const aov = parseFuzzy(newInputs.aov);
              const d = parseFuzzy(newInputs.days);
              const dailyRev = parseFuzzy(newInputs.dailyRevenue);
              const paidClicks = parseFuzzy(newInputs.paidClicks);
              const ppc = parseFuzzy(newInputs.ppc);
              const dailyAd = parseFuzzy(newInputs.dailyAdSpend);

              if (name === 'dailyRevenue') {
                  if (strValue !== '' && d.mid > 0 && aov.mid > 0) {
                      const minOrd = Math.round((dailyRev.min * d.min) / aov.max);
                      const maxOrd = Math.round((dailyRev.max * d.max) / aov.min);
                      newInputs.totalOrders = (dailyRev.isRange || aov.isRange) ? `${minOrd}-${maxOrd}` : String(Math.round((dailyRev.mid * d.mid) / aov.mid));
                      
                      const updatedOrders = parseFuzzy(newInputs.totalOrders);
                      if (cvr.mid > 0) {
                          const minPv = Math.round(updatedOrders.min / (cvr.max / 100));
                          const maxPv = Math.round(updatedOrders.max / (cvr.min / 100));
                          newInputs.pv = (updatedOrders.isRange || cvr.isRange) ? `${minPv}-${maxPv}` : String(Math.round(updatedOrders.mid / (cvr.mid / 100)));
                      }
                  }
              } else if (name === 'totalOrders') {
                  if (strValue !== '' && d.mid > 0 && aov.mid > 0) {
                      const minDaily = Math.round((orders.min * aov.min) / d.max);
                      const maxDaily = Math.round((orders.max * aov.max) / d.min);
                      newInputs.dailyRevenue = (orders.isRange || aov.isRange) ? `${minDaily}-${maxDaily}` : String(Math.round((orders.mid * aov.mid) / d.mid));
                  }
                  if (strValue !== '' && cvr.mid > 0) { 
                      const minPv = Math.round(orders.min / (cvr.max / 100));
                      const maxPv = Math.round(orders.max / (cvr.min / 100));
                      newInputs.pv = (orders.isRange || cvr.isRange) ? `${minPv}-${maxPv}` : String(Math.round(orders.mid / (cvr.mid / 100)));
                  }
              } else if (name === 'cvr') {
                  if (strValue !== '' && orders.mid > 0) { 
                      const minPv = Math.round(orders.min / (cvr.max / 100));
                      const maxPv = Math.round(orders.max / (cvr.min / 100));
                      newInputs.pv = (orders.isRange || cvr.isRange) ? `${minPv}-${maxPv}` : String(Math.round(orders.mid / (cvr.mid / 100)));
                  }
              } else if (name === 'pv') {
                  if (strValue !== '') {
                      if (cvr.mid > 0) {
                          const minOrd = Math.round(pv.min * (cvr.min / 100));
                          const maxOrd = Math.round(pv.max * (cvr.max / 100));
                          newInputs.totalOrders = (pv.isRange || cvr.isRange) ? `${minOrd}-${maxOrd}` : String(Math.round(pv.mid * (cvr.mid / 100)));
                          
                          const updatedOrders = parseFuzzy(newInputs.totalOrders);
                          if (d.mid > 0 && aov.mid > 0) {
                              const minDaily = Math.round((updatedOrders.min * aov.min) / d.max);
                              const maxDaily = Math.round((updatedOrders.max * aov.max) / d.min);
                              newInputs.dailyRevenue = (updatedOrders.isRange || aov.isRange) ? `${minDaily}-${maxDaily}` : String(Math.round((updatedOrders.mid * aov.mid) / d.mid));
                          }
                      } else if (orders.mid > 0) {
                          const minCvr = ((orders.min / pv.max) * 100).toFixed(2);
                          const maxCvr = ((orders.max / pv.min) * 100).toFixed(2);
                          newInputs.cvr = (pv.isRange || orders.isRange) ? `${minCvr}-${maxCvr}` : ((orders.mid / pv.mid) * 100).toFixed(2);
                      }
                  }
              } else if (name === 'aov' || name === 'days') {
                  if (newInputs.totalOrders !== '' && orders.mid > 0 && d.mid > 0 && aov.mid > 0) {
                      const minDaily = Math.round((orders.min * aov.min) / d.max);
                      const maxDaily = Math.round((orders.max * aov.max) / d.min);
                      newInputs.dailyRevenue = (orders.isRange || aov.isRange) ? `${minDaily}-${maxDaily}` : String(Math.round((orders.mid * aov.mid) / d.mid));
                  } else if (newInputs.dailyRevenue !== '' && dailyRev.mid > 0 && d.mid > 0 && aov.mid > 0) {
                      const minOrd = Math.round((dailyRev.min * d.min) / aov.max);
                      const maxOrd = Math.round((dailyRev.max * d.max) / aov.min);
                      newInputs.totalOrders = (dailyRev.isRange || aov.isRange) ? `${minOrd}-${maxOrd}` : String(Math.round((dailyRev.mid * d.mid) / aov.mid));
                      
                      const updatedOrders = parseFuzzy(newInputs.totalOrders);
                      if (cvr.mid > 0) { 
                          const minPv = Math.round(updatedOrders.min / (cvr.max / 100));
                          const maxPv = Math.round(updatedOrders.max / (cvr.min / 100));
                          newInputs.pv = (updatedOrders.isRange || cvr.isRange) ? `${minPv}-${maxPv}` : String(Math.round(updatedOrders.mid / (cvr.mid / 100)));
                      }
                  }
              }

              if (name === 'dailyAdSpend') {
                  if (strValue !== '' && d.mid > 0 && ppc.mid > 0) {
                      const minClicks = Math.round((dailyAd.min * d.min) / ppc.max);
                      const maxClicks = Math.round((dailyAd.max * d.max) / ppc.min);
                      newInputs.paidClicks = (dailyAd.isRange || ppc.isRange) ? `${minClicks}-${maxClicks}` : String(Math.round((dailyAd.mid * d.mid) / ppc.mid));
                  }
              } else if (name === 'paidClicks') {
                  if (strValue !== '' && d.mid > 0 && ppc.mid > 0) {
                      const minDailyAd = Math.round((paidClicks.min * ppc.min) / d.max);
                      const maxDailyAd = Math.round((paidClicks.max * ppc.max) / d.min);
                      newInputs.dailyAdSpend = (paidClicks.isRange || ppc.isRange) ? `${minDailyAd}-${maxDailyAd}` : String(Math.round((paidClicks.mid * ppc.mid) / d.mid));
                  }
              } else if (name === 'ppc' || name === 'days') {
                  if (newInputs.paidClicks !== '' && paidClicks.mid > 0 && d.mid > 0 && ppc.mid > 0) {
                      const minDailyAd = Math.round((paidClicks.min * ppc.min) / d.max);
                      const maxDailyAd = Math.round((paidClicks.max * ppc.max) / d.min);
                      newInputs.dailyAdSpend = (paidClicks.isRange || ppc.isRange) ? `${minDailyAd}-${maxDailyAd}` : String(Math.round((paidClicks.mid * ppc.mid) / d.mid));
                  } else if (newInputs.dailyAdSpend !== '' && dailyAd.mid > 0 && d.mid > 0 && ppc.mid > 0) {
                      const minClicks = Math.round((dailyAd.min * d.min) / ppc.max);
                      const maxClicks = Math.round((dailyAd.max * d.max) / ppc.min);
                      newInputs.paidClicks = (dailyAd.isRange || ppc.isRange) ? `${minClicks}-${maxClicks}` : String(Math.round((dailyAd.mid * d.mid) / ppc.mid));
                  }
              }

              return { ...comp, inputs: newInputs };
            }));
          };

          const results = useMemo(() => {
            const daysStr = parseFuzzy(inputs.days);
            const days = daysStr.mid > 0 ? daysStr.mid : 1; 

            const pv = parseFuzzy(inputs.pv);
            const cvr = parseFuzzy(inputs.cvr); 
            const aov = parseFuzzy(inputs.aov);
            const paidClicks = parseFuzzy(inputs.paidClicks);
            const ppc = parseFuzzy(inputs.ppc);
            const margin = parseFuzzy(inputs.margin);
            const returnRate = parseFuzzy(inputs.returnRate);
            
            const rawFixedCosts = parseFuzzy(inputs.fixedCosts);
            const fixedCosts = {
              min: (rawFixedCosts.min / 30) * days,
              max: (rawFixedCosts.max / 30) * days,
              mid: (rawFixedCosts.mid / 30) * days
            };

            const parsedOrders = parseFuzzy(inputs.totalOrders);
            const totalOrders = {
              min: parsedOrders.min || (pv.min * (cvr.min / 100)),
              max: parsedOrders.max || (pv.max * (cvr.max / 100)),
              mid: parsedOrders.mid || (pv.mid * (cvr.mid / 100))
            };

            const parsedDailyRev = parseFuzzy(inputs.dailyRevenue);
            const totalRevenue = {
              min: (totalOrders.min > 0 && aov.min > 0) ? totalOrders.min * aov.min : parsedDailyRev.min * days,
              max: (totalOrders.max > 0 && aov.max > 0) ? totalOrders.max * aov.max : parsedDailyRev.max * days,
              mid: (totalOrders.mid > 0 && aov.mid > 0) ? totalOrders.mid * aov.mid : parsedDailyRev.mid * days
            };
            
            const parsedDailyAd = parseFuzzy(inputs.dailyAdSpend);
            const adSpend = {
              min: (paidClicks.min > 0 && ppc.min > 0) ? paidClicks.min * ppc.min : parsedDailyAd.min * days,
              max: (paidClicks.max > 0 && ppc.max > 0) ? paidClicks.max * ppc.max : parsedDailyAd.max * days,
              mid: (paidClicks.mid > 0 && ppc.mid > 0) ? paidClicks.mid * ppc.mid : parsedDailyAd.mid * days
            };

            const netRevenue = {
              min: totalRevenue.min * (1 - (returnRate.max / 100)),
              max: totalRevenue.max * (1 - (returnRate.min / 100)),
              mid: totalRevenue.mid * (1 - (returnRate.mid / 100))
            };
            
            const returnLoss = {
              min: totalRevenue.min - netRevenue.max,
              max: totalRevenue.max - netRevenue.min,
              mid: totalRevenue.mid - netRevenue.mid
            };

            const grossProfit = {
              min: netRevenue.min * (margin.min / 100),
              max: netRevenue.max * (margin.max / 100),
              mid: netRevenue.mid * (margin.mid / 100)
            };

            const netProfit = {
              min: grossProfit.min - adSpend.max - fixedCosts.max,
              max: grossProfit.max - adSpend.min - fixedCosts.min,
              mid: grossProfit.mid - adSpend.mid - fixedCosts.mid
            };

            const profitMargin = {
              min: totalRevenue.min > 0 ? (netProfit.min / totalRevenue.min) * 100 : 0,
              max: totalRevenue.max > 0 ? (netProfit.max / totalRevenue.max) * 100 : 0,
              mid: totalRevenue.mid > 0 ? (netProfit.mid / totalRevenue.mid) * 100 : 0
            };

            const totalROI = {
              min: adSpend.max > 0 ? totalRevenue.min / adSpend.max : 0,
              max: adSpend.min > 0 ? totalRevenue.max / adSpend.min : 0,
              mid: adSpend.mid > 0 ? totalRevenue.mid / adSpend.mid : 0
            };

            const adDependency = {
              min: totalRevenue.max > 0 ? (adSpend.min / totalRevenue.max) * 100 : 0,
              max: totalRevenue.min > 0 ? (adSpend.max / totalRevenue.min) * 100 : 0,
              mid: totalRevenue.mid > 0 ? (adSpend.mid / totalRevenue.mid) * 100 : 0
            };

            const denomMid = (1 - returnRate.mid / 100) * (margin.mid / 100) - (totalRevenue.mid > 0 ? fixedCosts.mid / totalRevenue.mid : 0);
            const denomMax = (1 - returnRate.min / 100) * (margin.max / 100) - (totalRevenue.max > 0 ? fixedCosts.min / totalRevenue.max : 0);
            const denomMin = (1 - returnRate.max / 100) * (margin.min / 100) - (totalRevenue.min > 0 ? fixedCosts.max / totalRevenue.min : 0);

            const breakevenROI = {
              min: denomMax > 0 ? 1 / denomMax : 0,
              max: denomMin > 0 ? 1 / denomMin : 0,
              mid: denomMid > 0 ? 1 / denomMid : 0
            };

            const maxPPC = {
              min: (cvr.min / 100) * aov.min * (1 - returnRate.max / 100) * (margin.min / 100),
              max: (cvr.max / 100) * aov.max * (1 - returnRate.min / 100) * (margin.max / 100),
              mid: (cvr.mid / 100) * aov.mid * (1 - returnRate.mid / 100) * (margin.mid / 100)
            };

            const dailyOrders = { min: totalOrders.min / days, max: totalOrders.max / days, mid: totalOrders.mid / days };
            const dailyRevenue = { min: totalRevenue.min / days, max: totalRevenue.max / days, mid: totalRevenue.mid / days };
            const monthlyRevenue = { min: dailyRevenue.min * 30, max: dailyRevenue.max * 30, mid: dailyRevenue.mid * 30 };
            const dailyAdSpend = { min: adSpend.min / days, max: adSpend.max / days, mid: adSpend.mid / days };
            const monthlyAdSpend = { min: dailyAdSpend.min * 30, max: dailyAdSpend.max * 30, mid: dailyAdSpend.mid * 30 };
            const dailyNetProfit = { min: netProfit.min / days, max: netProfit.max / days, mid: netProfit.mid / days };
            const monthlyNetProfit = { min: dailyNetProfit.min * 30, max: dailyNetProfit.max * 30, mid: dailyNetProfit.mid * 30 };

            const totalRevBase = totalRevenue.mid || 1; 
            const pctReturn = (returnLoss.mid / totalRevBase) * 100;
            const pctCOGS = ((netRevenue.mid - grossProfit.mid) / totalRevBase) * 100;
            const pctAd = (adSpend.mid / totalRevBase) * 100;
            const pctFixed = (fixedCosts.mid / totalRevBase) * 100;
            const pctProfit = Math.max(0, (netProfit.mid / totalRevBase) * 100); 

            return {
              totalOrders, totalRevenue, adSpend, netRevenue, returnLoss, 
              grossProfit, fixedCosts, netProfit, profitMargin, totalROI, 
              adDependency, breakevenROI, maxPPC, dailyRevenue, monthlyRevenue, 
              dailyAdSpend, monthlyAdSpend, dailyNetProfit, monthlyNetProfit, dailyOrders,
              pctReturn, pctCOGS, pctAd, pctFixed, pctProfit
            };
          }, [inputs]);

          const formatMoney = (num) => new Intl.NumberFormat('zh-CN', { style: 'currency', currency: 'CNY', maximumFractionDigits: 0 }).format(num || 0);
          const formatPPC = (num) => new Intl.NumberFormat('zh-CN', { style: 'currency', currency: 'CNY', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(num || 0);
          const formatNum = (num) => new Intl.NumberFormat('zh-CN', { maximumFractionDigits: 1 }).format(num || 0);
          const formatPercent = (num) => `${(num || 0).toFixed(2)}%`;

          const formatMoneyRange = (resultRange) => {
              if (!resultRange) return formatMoney(0);
              if (resultRange.min !== resultRange.max && !isNaN(resultRange.min)) {
                   return `${formatMoney(resultRange.min)} ~ ${formatMoney(resultRange.max)}`;
              }
              return formatMoney(resultRange.mid);
          };

          const RangeDisplay = ({ data, type = 'money' }) => {
            if (!data || data.min === data.max || isNaN(data.min)) return null;
            const format = (v) => type === 'money' ? formatMoney(v) : type === 'percent' ? formatPercent(v) : formatNum(v);
            return (
              <div className="mt-2 text-xs text-gray-500 bg-white/60 px-2 py-1 rounded inline-block border border-gray-100 shadow-sm" title="基于您输入的区间反推的上下限">
                <span className="text-gray-400 mr-1">极限区间:</span> {format(data.min)} ~ {format(data.max)}
              </div>
            );
          };

          return (
            <div className="min-h-screen bg-gray-50 text-gray-800 p-4 md:p-8 font-sans relative">
              {toast.show && (
                <div className={`fixed top-4 left-1/2 transform -translate-x-1/2 z-50 px-6 py-3 rounded-full shadow-lg flex items-center gap-2 transition-all ${toast.type === 'success' ? 'bg-green-100 text-green-800 border border-green-200' : 'bg-red-100 text-red-800 border border-red-200'}`}>
                  {toast.type === 'success' ? <CheckCircle2 className="w-5 h-5" /> : <AlertCircle className="w-5 h-5" />}
                  <span className="font-medium text-sm">{toast.message}</span>
                </div>
              )}

              <div className="max-w-7xl mx-auto">
                <div className="mb-6 flex flex-col md:flex-row md:items-center justify-between gap-4">
                  <div>
                    <h1 className="text-3xl font-bold text-indigo-900 flex items-center gap-3">
                      <Activity className="w-8 h-8 text-indigo-600" />
                      多竞品模糊区间反推系统
                    </h1>
                    <p className="text-gray-500 mt-2">支持直填达摩盘模糊数据 (如 40-45万)，自动进行极值碰撞与全链路互推。</p>
                  </div>
                  <div className="flex gap-2 shrink-0 flex-wrap justify-end">
                    <button onClick={() => setShowProfit(!showProfit)} className="text-sm flex items-center gap-2 bg-white hover:bg-gray-50 text-gray-700 py-2 px-4 rounded-xl border border-gray-200 transition-colors shadow-sm">
                      {showProfit ? <><EyeOff className="w-4 h-4" /> 隐藏利润</> : <><Eye className="w-4 h-4" /> 显示利润</>}
                    </button>
                    <button onClick={handleClearAll} className="text-sm flex items-center gap-2 bg-red-50 hover:bg-red-100 text-red-600 py-2 px-4 rounded-xl border border-red-200 transition-colors shadow-sm">
                      <RotateCcw className="w-4 h-4" /> 清空全部
                    </button>
                    <label className="cursor-pointer text-sm flex items-center gap-2 bg-white hover:bg-gray-50 text-gray-700 py-2 px-4 rounded-xl border border-gray-200 transition-colors shadow-sm">
                      <Upload className="w-4 h-4" /> 导入配置
                      <input type="file" accept=".json" className="hidden" onChange={handleImport} />
                    </label>
                    <button onClick={handleExport} className="text-sm flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded-xl shadow-sm transition-colors">
                      <Download className="w-4 h-4" /> 导出全部
                    </button>
                  </div>
                </div>

                <div className="flex items-center gap-2 overflow-x-auto mb-6 pb-2 scrollbar-hide">
                  <div className="flex items-center gap-1 bg-gray-200/50 p-1 rounded-xl">
                    {competitors.map(c => (
                      <div 
                        key={c.id}
                        onClick={() => setActiveId(c.id)}
                        className={`group flex items-center gap-2 px-5 py-2.5 rounded-lg font-medium cursor-pointer transition-all ${activeId === c.id ? 'bg-white text-indigo-700 shadow-sm' : 'text-gray-500 hover:text-gray-800 hover:bg-gray-100/50'}`}
                      >
                        <Users className={`w-4 h-4 ${activeId === c.id ? 'text-indigo-500' : 'text-gray-400'}`} />
                        {c.name}
                        {competitors.length > 1 && (
                          <button 
                            onClick={(e) => handleDeleteCompetitor(e, c.id)} 
                            className={`p-1 rounded-md transition-opacity ${activeId === c.id ? 'opacity-100 text-gray-400 hover:text-red-500 hover:bg-red-50' : 'opacity-0 group-hover:opacity-100 text-gray-400 hover:text-red-500'}`}
                            title="删除该竞品"
                          >
                            <Trash2 className="w-3.5 h-3.5" />
                          </button>
                        )}
                      </div>
                    ))}
                    <button 
                      onClick={handleAddCompetitor} 
                      className="flex items-center gap-1 px-4 py-2.5 rounded-lg font-medium text-gray-500 hover:text-indigo-600 hover:bg-indigo-50 transition-colors shrink-0"
                    >
                      <Plus className="w-4 h-4" /> 添加竞品
                    </button>
                  </div>
                </div>

                <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                  <div className="lg:col-span-4 space-y-6">
                    <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 relative overflow-hidden">
                      <div className="absolute top-0 right-0 p-4 opacity-5">
                        <Calculator className="w-32 h-32" />
                      </div>

                      <h2 className="text-lg font-semibold text-gray-800 flex items-center justify-between border-b border-gray-100 pb-4 mb-5 relative z-10">
                        <div className="flex items-center gap-2">
                          <span className="w-2 h-6 bg-indigo-500 rounded-full"></span>
                          输入面板: {activeCompetitor.name}
                        </div>
                        <button onClick={handleClearCurrent} className="text-xs flex items-center gap-1 text-gray-500 hover:text-red-500 transition-colors bg-gray-50 hover:bg-red-50 py-1.5 px-3 rounded-lg border border-gray-200 hover:border-red-200">
                          <RotateCcw className="w-3.5 h-3.5" /> 清空当前
                        </button>
                      </h2>

                      <div className="bg-blue-50/50 border border-blue-100 p-3 rounded-lg mb-4 text-xs text-blue-800 flex items-start gap-2 relative z-10">
                         <SplitSquareHorizontal className="w-4 h-4 mt-0.5 shrink-0" />
                         <p>您可以直接输入达摩盘给出的<b>模糊区间</b>（如：<code>40-45万</code> 或 <code>0.5-1</code>），系统将自动进行高低位极值估算。</p>
                      </div>
                      
                      <div className="space-y-6 relative z-10">
                        
                        {/* 1. 全新的日均前置互推模块 */}
                        <div className="bg-indigo-50/50 p-4 rounded-xl border border-indigo-100 shadow-sm">
                          <h3 className="text-xs font-bold text-indigo-700 uppercase tracking-wider mb-4 flex items-center gap-2">
                            <Calculator className="w-3.5 h-3.5" /> 日均前置设定与推算 (互推引擎)
                          </h3>
                          <div className="space-y-4">
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">数据统计天数 (天)</label>
                              <input type="text" name="days" placeholder="如: 30" value={inputs.days} onChange={handleInputChange} className="w-full px-4 py-2.5 bg-white border border-indigo-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all font-semibold text-indigo-900 shadow-sm" />
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                              <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">日均营业额</label>
                                <input type="text" name="dailyRevenue" placeholder="支持互推" value={inputs.dailyRevenue} onChange={handleInputChange} className="w-full px-4 py-2.5 bg-white border border-indigo-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all text-indigo-900 shadow-sm" />
                                <div className="text-xs text-indigo-600/80 mt-1.5 font-medium flex flex-col gap-0.5">
                                  <span>预估月: <span className="text-gray-600">{formatMoneyRange(results.monthlyRevenue)}</span></span>
                                </div>
                              </div>
                              <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">日推广付费</label>
                                <input type="text" name="dailyAdSpend" placeholder="支持互推" value={inputs.dailyAdSpend} onChange={handleInputChange} className="w-full px-4 py-2.5 bg-white border border-indigo-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all text-indigo-900 shadow-sm" />
                                <div className="text-xs text-indigo-600/80 mt-1.5 font-medium flex flex-col gap-0.5">
                                  <span>预估月: <span className="text-gray-600">{formatMoneyRange(results.monthlyAdSpend)}</span></span>
                                </div>
                              </div>
                            </div>
                            
                            {/* 日均净利润展示 */}
                            {showProfit && (
                              <div className="bg-white p-3 rounded-lg border border-indigo-100 flex justify-between items-center shadow-sm">
                                <span className="text-sm font-medium text-gray-600">日均净利推算:</span>
                                <div className="text-right">
                                  <div className={`text-lg font-bold break-all ${results.dailyNetProfit.mid >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                    {results.dailyNetProfit.min !== results.dailyNetProfit.max 
                                      ? `${formatMoney(results.dailyNetProfit.min)} ~ ${formatMoney(results.dailyNetProfit.max)}`
                                      : formatMoney(results.dailyNetProfit.mid)} <span className="text-sm font-normal text-gray-500">/天</span>
                                  </div>
                                  <div className="text-xs text-gray-500">预估月: {formatMoneyRange(results.monthlyNetProfit)}</div>
                                </div>
                              </div>
                            )}
                          </div>
                        </div>

                        {/* 2. 原流量转化模块 */}
                        <div className="bg-gray-50/50 p-4 rounded-xl border border-gray-100">
                          <h3 className="text-xs font-bold text-gray-500 uppercase tracking-wider mb-4 flex items-center gap-2">
                            <Activity className="w-3.5 h-3.5" /> 流量与转化
                          </h3>
                          <div className="space-y-4">
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">整体IPV (总流量)</label>
                              <input type="text" name="pv" placeholder="支持互推 / 区间" value={inputs.pv} onChange={handleInputChange} className="w-full px-4 py-2.5 bg-indigo-50 border border-indigo-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all text-indigo-900 shadow-sm" />
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                              <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">转化率 (%)</label>
                                <input type="text" name="cvr" placeholder="如: 0.5-1" value={inputs.cvr} onChange={handleInputChange} className="w-full px-4 py-2.5 bg-indigo-50 border border-indigo-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all text-indigo-900 shadow-sm" />
                              </div>
                              <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">成交笔数</label>
                                <input type="text" name="totalOrders" placeholder="填入数据或被推算" value={inputs.totalOrders} onChange={handleInputChange} className="w-full px-4 py-2.5 bg-indigo-50 border border-indigo-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all text-indigo-900 shadow-sm" />
                                {Number(parseFuzzy(inputs.days).mid) > 0 && results.totalOrders.mid > 0 && (
                                  <div className="mt-1.5 space-y-1">
                                    <p className="text-xs text-indigo-600/80 font-medium flex items-start gap-1">
                                      <Activity className="w-3 h-3 mt-0.5 shrink-0" /> 
                                      <span>日均单量: {
                                        results.dailyOrders.min !== results.dailyOrders.max
                                        ? `${formatNum(Math.round(results.dailyOrders.min))} ~ ${formatNum(Math.round(results.dailyOrders.max))} 笔/天`
                                        : `${formatNum(Math.round(results.dailyOrders.mid))} 笔/天`
                                      }</span>
                                    </p>
                                    {results.totalRevenue.mid > 0 && (
                                      <p className="text-xs text-indigo-600/80 font-medium flex items-start gap-1">
                                        <DollarSign className="w-3 h-3 mt-0.5 shrink-0" /> 
                                        <span>预估总营收: {formatMoneyRange(results.totalRevenue)}</span>
                                      </p>
                                    )}
                                    {results.dailyRevenue.mid > 0 && (
                                      <p className="text-xs text-indigo-600/80 font-medium flex items-start gap-1">
                                        <Activity className="w-3 h-3 mt-0.5 shrink-0" /> 
                                        <span>日均营收: {formatMoneyRange(results.dailyRevenue)}/天</span>
                                      </p>
                                    )}
                                  </div>
                                )}
                              </div>
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">客单价 (元)</label>
                              <input type="text" name="aov" placeholder="如: 100-200" value={inputs.aov} onChange={handleInputChange} className="w-full px-4 py-2.5 bg-white border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all shadow-sm" />
                            </div>
                          </div>
                        </div>

                        <div className="bg-orange-50/30 p-4 rounded-xl border border-orange-100/50">
                          <h3 className="text-xs font-bold text-orange-600/70 uppercase tracking-wider mb-4 flex items-center gap-2">
                            <MousePointerClick className="w-3.5 h-3.5" /> 广告推广
                          </h3>
                          <div className="grid grid-cols-2 gap-4">
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">付费点击量</label>
                              <input type="text" name="paidClicks" placeholder="如: 3-4w" value={inputs.paidClicks} onChange={handleInputChange} className="w-full px-4 py-2.5 bg-white border border-gray-200 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all shadow-sm" />
                            </div>
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">PPC成本 (元)</label>
                              <input type="text" name="ppc" placeholder="如: 0.5-1.0" value={inputs.ppc} onChange={handleInputChange} className="w-full px-4 py-2.5 bg-white border border-gray-200 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all shadow-sm" />
                            </div>
                            {results.adSpend.mid > 0 && (
                              <div className="col-span-2">
                                <p className="text-xs text-orange-600/80 font-medium flex items-center gap-1">
                                  <DollarSign className="w-3 h-3 shrink-0" />
                                  <span>预估总花费: {formatMoneyRange(results.adSpend)}</span>
                                </p>
                              </div>
                            )}
                          </div>
                        </div>

                        <div className="bg-red-50/30 p-4 rounded-xl border border-red-100/50">
                          <h3 className="text-xs font-bold text-red-500/70 uppercase tracking-wider mb-4 flex items-center gap-2">
                            <DollarSign className="w-3.5 h-3.5" /> 成本与损耗 (核心)
                          </h3>
                          <div className="space-y-4">
                            <div className="grid grid-cols-2 gap-4">
                              <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">预估毛利率 (%)</label>
                                <input type="text" name="margin" placeholder="输入区间或确值" value={inputs.margin} onChange={handleInputChange} className="w-full px-4 py-2.5 bg-white border border-gray-200 rounded-lg focus:ring-2 focus:ring-red-400 focus:border-red-400 transition-all shadow-sm" />
                              </div>
                              <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">预估退货率 (%)</label>
                                <input type="text" name="returnRate" placeholder="输入区间或确值" value={inputs.returnRate} onChange={handleInputChange} className="w-full px-4 py-2.5 bg-white border border-gray-200 rounded-lg focus:ring-2 focus:ring-red-400 focus:border-red-400 transition-all shadow-sm" />
                              </div>
                            </div>
                            <div className="pt-2 border-t border-red-100">
                              <label className="block text-sm font-medium text-gray-700 mb-1 flex items-center justify-between">
                                <span>固定运营成本 (元/月)</span>
                                <span className="text-[10px] font-normal text-gray-400 bg-white px-1.5 py-0.5 rounded border">按30天折算</span>
                              </label>
                              <input type="text" name="fixedCosts" placeholder="输入月度固定花销" value={inputs.fixedCosts} onChange={handleInputChange} className="w-full px-4 py-2.5 bg-white border border-gray-200 rounded-lg focus:ring-2 focus:ring-red-400 focus:border-red-400 transition-all shadow-sm" />
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* 右侧：结果展示区 */}
                  <div className="lg:col-span-8 space-y-6">
                    <div className={`grid grid-cols-1 ${showProfit ? 'md:grid-cols-3' : 'md:grid-cols-2'} gap-4`}>
                      <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 flex flex-col justify-between overflow-hidden relative group hover:border-blue-200 transition-colors">
                        <div className="absolute -right-4 -top-4 opacity-5 group-hover:opacity-10 transition-opacity">
                          <DollarSign className="w-32 h-32 text-blue-600" />
                        </div>
                        <p className="text-sm font-medium text-gray-500 mb-2">预估总营业额 (中位)</p>
                        <h3 className="text-3xl font-bold text-gray-900">{formatMoney(results.totalRevenue.mid)}</h3>
                        <RangeDisplay data={results.totalRevenue} />
                        <div className="mt-4 flex flex-col gap-1 text-sm text-gray-500 bg-gray-50 p-2 rounded-lg">
                          <span className="flex items-center gap-1"><ShoppingCart className="w-4 h-4 text-gray-400" /> 成交中位: {formatNum(results.totalOrders.mid)} 笔</span>
                        </div>
                      </div>

                      <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 flex flex-col justify-between relative overflow-hidden group hover:border-orange-200 transition-colors">
                         <div className="absolute -right-4 -top-4 opacity-5 group-hover:opacity-10 transition-opacity">
                          <MousePointerClick className="w-32 h-32 text-orange-500" />
                        </div>
                        <p className="text-sm font-medium text-gray-500 mb-2">广告总花费 (中位)</p>
                        <h3 className="text-3xl font-bold text-orange-600">{formatMoney(results.adSpend.mid)}</h3>
                        <RangeDisplay data={results.adSpend} />
                        <div className="mt-4 flex flex-col gap-1 text-sm text-gray-500 bg-orange-50 p-2 rounded-lg">
                          <span className="flex items-center gap-1"><Percent className="w-4 h-4 text-orange-400" /> 费率中位: {formatPercent(results.adDependency.mid)}</span>
                        </div>
                      </div>

                      {showProfit && (
                        <div className={`rounded-2xl shadow-sm border p-6 flex flex-col justify-between relative overflow-hidden group transition-colors ${results.netProfit.mid >= 0 ? 'bg-gradient-to-br from-green-50 to-white border-green-200' : 'bg-gradient-to-br from-red-50 to-white border-red-200'}`}>
                          <div className="absolute -right-4 -top-4 opacity-5 group-hover:opacity-10 transition-opacity">
                            <TrendingUp className={`w-32 h-32 ${results.netProfit.mid >= 0 ? 'text-green-500' : 'text-red-500'}`} />
                          </div>
                          <p className="text-sm font-medium text-gray-600 mb-2">核心净利润 (中位)</p>
                          <h3 className={`text-3xl font-bold ${results.netProfit.mid >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                            {formatMoney(results.netProfit.mid)}
                          </h3>
                          <RangeDisplay data={results.netProfit} />
                          <div className={`mt-4 flex items-center gap-2 text-sm p-2 rounded-lg ${results.netProfit.mid >= 0 ? 'bg-green-100/50 text-green-700' : 'bg-red-100/50 text-red-700'}`}>
                            <Activity className="w-4 h-4" />
                            净利率中位: {formatPercent(results.profitMargin.mid)}
                          </div>
                        </div>
                      )}
                    </div>

                    <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                      <h3 className="text-lg font-semibold text-gray-800 mb-6 flex items-center gap-2">
                         <DollarSign className="w-5 h-5 text-green-500" />
                         中位预期资金流向拆解
                      </h3>
                      
                      <div className="space-y-6">
                        <div className="w-full h-10 bg-gray-100 rounded-full overflow-hidden flex shadow-inner">
                          {results.totalRevenue.mid > 0 ? (
                            <>
                              <div style={{ width: `${results.pctCOGS}%` }} className="bg-slate-300 h-full flex items-center justify-center text-xs text-slate-700 font-medium hover:opacity-80 transition-opacity" title={`商品成本: ${formatPercent(results.pctCOGS)}`}>
                                {results.pctCOGS > 5 && '商品成本'}
                              </div>
                              <div style={{ width: `${results.pctReturn}%` }} className="bg-red-400 h-full flex items-center justify-center text-xs text-white font-medium hover:opacity-80 transition-opacity" title={`退货流失: ${formatPercent(results.pctReturn)}`}>
                                {results.pctReturn > 5 && '退货'}
                              </div>
                              <div style={{ width: `${results.pctAd}%` }} className="bg-orange-400 h-full flex items-center justify-center text-xs text-white font-medium hover:opacity-80 transition-opacity" title={`广告花费: ${formatPercent(results.pctAd)}`}>
                                {results.pctAd > 5 && '广告'}
                              </div>
                              {results.pctFixed > 0 && (
                                <div style={{ width: `${results.pctFixed}%` }} className="bg-purple-400 h-full flex items-center justify-center text-xs text-white font-medium border-l border-white/20 hover:opacity-80 transition-opacity" title={`固定成本(折算后): ${formatPercent(results.pctFixed)}`}>
                                   {results.pctFixed > 5 && '固定成本'}
                                </div>
                              )}
                              {/* 隐藏利润时，变为灰色马赛克区域 */}
                              {results.pctProfit > 0 && (
                                <div style={{ width: `${results.pctProfit}%` }} className={`${showProfit ? 'bg-green-500 text-white' : 'bg-gray-300 text-gray-500'} h-full flex items-center justify-center text-xs font-medium border-l border-white/20 hover:opacity-80 transition-opacity`} title={showProfit ? `净利润: ${formatPercent(results.pctProfit)}` : '利润已隐藏'}>
                                  {results.pctProfit > 5 && (showProfit ? '净利润' : '***')}
                                </div>
                              )}
                            </>
                          ) : (
                            <div className="w-full h-full flex items-center justify-center text-sm text-gray-400">请输入有效营收数据生成流向图</div>
                          )}
                        </div>

                        <div className={`grid grid-cols-2 ${showProfit ? 'md:grid-cols-5' : 'md:grid-cols-4'} gap-3 pt-2`}>
                          <div className="p-3 rounded-lg bg-slate-50 border border-slate-100 text-center md:text-left">
                            <div className="flex items-center justify-center md:justify-start gap-2 mb-1">
                              <div className="w-3 h-3 rounded-full bg-slate-300"></div>
                              <span className="text-xs text-gray-500">商品成本</span>
                            </div>
                            <p className="font-semibold text-gray-800 text-sm">{formatMoney(results.netRevenue.mid - results.grossProfit.mid)}</p>
                          </div>
                          <div className="p-3 rounded-lg bg-red-50 border border-red-100 text-center md:text-left">
                            <div className="flex items-center justify-center md:justify-start gap-2 mb-1">
                              <div className="w-3 h-3 rounded-full bg-red-400"></div>
                              <span className="text-xs text-gray-500">退货流失</span>
                            </div>
                            <p className="font-semibold text-gray-800 text-sm">{formatMoney(results.returnLoss.mid)}</p>
                          </div>
                          <div className="p-3 rounded-lg bg-orange-50 border border-orange-100 text-center md:text-left">
                            <div className="flex items-center justify-center md:justify-start gap-2 mb-1">
                              <div className="w-3 h-3 rounded-full bg-orange-400"></div>
                              <span className="text-xs text-gray-500">广告花费</span>
                            </div>
                            <p className="font-semibold text-gray-800 text-sm">{formatMoney(results.adSpend.mid)}</p>
                          </div>
                          <div className="p-3 rounded-lg bg-purple-50 border border-purple-100 text-center md:text-left">
                            <div className="flex items-center justify-center md:justify-start gap-2 mb-1">
                              <div className="w-3 h-3 rounded-full bg-purple-400"></div>
                              <span className="text-xs text-gray-500">本期固定成本</span>
                            </div>
                            <p className="font-semibold text-gray-800 text-sm">{formatMoney(results.fixedCosts.mid)}</p>
                          </div>
                          {showProfit && (
                            <div className="p-3 rounded-lg bg-green-50 border border-green-100 text-center md:text-left">
                              <div className="flex items-center justify-center md:justify-start gap-2 mb-1">
                                <div className="w-3 h-3 rounded-full bg-green-500"></div>
                                <span className="text-xs text-gray-500">最终净利润</span>
                              </div>
                              <p className="font-semibold text-gray-800 text-sm">{formatMoney(results.netProfit.mid)}</p>
                            </div>
                          )}
                        </div>
                      </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                       <div className="bg-indigo-50 rounded-2xl border border-indigo-100 p-6 flex flex-col justify-center">
                          <h4 className="text-indigo-900 font-semibold mb-4 flex items-center gap-2">
                            <Activity className="w-5 h-5" /> 策略健康度诊断
                          </h4>
                          <div className="space-y-4">
                            <div className="flex justify-between items-center border-b border-indigo-100 pb-2">
                              <span className="text-sm text-indigo-700">中位全店 ROI</span>
                              <div className="text-right">
                                <span className="text-xl font-bold text-indigo-900">{results.totalROI.mid.toFixed(2)}</span>
                                {(results.totalROI.min !== results.totalROI.max) && <div className="text-xs text-indigo-500">({results.totalROI.min.toFixed(2)}~{results.totalROI.max.toFixed(2)})</div>}
                              </div>
                            </div>
                            <div className="flex justify-between items-center border-b border-indigo-100 pb-2">
                              <span className="text-sm text-indigo-700">理论保本 ROI <span className="text-xs font-normal text-indigo-500">(含退货及本期成本)</span></span>
                              <div className="text-right">
                                {results.breakevenROI.mid > 0 ? (
                                  <>
                                    <span className="text-xl font-bold text-indigo-900">{results.breakevenROI.mid.toFixed(2)}</span>
                                    {(results.breakevenROI.min !== results.breakevenROI.max) && (
                                      <div className="text-xs text-indigo-500">
                                        ({results.breakevenROI.min > 0 ? results.breakevenROI.min.toFixed(2) : '无法保本'}~{results.breakevenROI.max > 0 ? results.breakevenROI.max.toFixed(2) : '无法保本'})
                                      </div>
                                    )}
                                  </>
                                ) : results.totalRevenue.mid > 0 ? (
                                  <span className="text-lg font-bold text-red-600">结构性亏损</span>
                                ) : (
                                  <span className="text-xl font-bold text-indigo-900">0.00</span>
                                )}
                              </div>
                            </div>
                            
                            {results.totalRevenue.mid > 0 && results.breakevenROI.mid === 0 ? (
                              <div className="mt-2 text-sm text-red-700 bg-red-100/60 border border-red-200 p-3 rounded-lg">
                                结论：该竞品处于结构性亏损状态（毛利不足以覆盖退货和固定成本），无论 ROI 多高都无法保本。
                              </div>
                            ) : results.totalROI.mid > 0 && results.totalROI.mid >= results.breakevenROI.mid ? (
                              <div className="mt-2 text-sm text-green-700 bg-green-100/60 border border-green-200 p-3 rounded-lg">
                                结论：目前该竞品大概率处于盈利放量状态，整体 ROI 健康。
                              </div>
                            ) : results.totalROI.mid > 0 ? (
                              <div className="mt-2 text-sm text-red-700 bg-red-100/60 border border-red-200 p-3 rounded-lg">
                                结论：该竞品大概率在亏损抢占市场份额，实际 ROI 低于保本线。
                              </div>
                            ) : (
                              <div className="mt-2 text-sm text-gray-500 bg-white/60 border border-indigo-200 p-3 rounded-lg">
                                待输入完整数据计算健康度。
                              </div>
                            )}
                          </div>
                       </div>

                       <div className="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 flex flex-col justify-center">
                          <h4 className="text-gray-800 font-semibold mb-4">竞品竞价极限值分析</h4>
                          <p className="text-sm text-gray-500 mb-4">
                            若竞品要保持不亏本，根据其转化与利润模型，所能承受的最高单次点击成本(PPC)极限为：
                          </p>
                          <div className="text-center py-4 bg-gray-50 rounded-lg border border-gray-100 relative">
                            <span className="text-sm text-gray-500 block mb-2">极限保本 PPC</span>
                            <div className="text-2xl md:text-3xl font-black text-gray-800 break-all px-2">
                              {results.maxPPC.min !== results.maxPPC.max
                                ? `${formatPPC(results.maxPPC.min)} ~ ${formatPPC(results.maxPPC.max)}`
                                : formatPPC(results.maxPPC.mid)}
                            </div>
                          </div>
                          <p className="text-xs text-gray-400 mt-4 text-center">
                            * 公式：转化率 × 客单价 × (1 - 退货率) × 毛利率。您的出价若低于此基准线，竞价更具优势。
                          </p>
                       </div>
                    </div>

                  </div>
                </div>
              </div>
            </div>
          );
        };

        // 挂载应用
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>